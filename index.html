<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .score-input { width: 45px; height: 45px; text-align: center; font-size: 1.25rem; font-weight: 900; border: 2px solid #cbd5e1; border-radius: 8px; }
        .score-input:focus { border-color: #3b82f6; outline: none; background: #eff6ff; }
    </style>
</head>
<body class="bg-slate-100 p-2 sm:p-6 max-w-5xl mx-auto font-sans text-slate-900">

    <div class="bg-white p-4 rounded-2xl shadow-lg border border-slate-200 mb-6 flex flex-wrap gap-4 justify-between items-center">
        <div>
            <h1 class="text-xl font-black italic uppercase text-blue-600 leading-none">Padel Admin</h1>
            <select id="tLoader" onchange="loadTournament(this.value)" class="mt-2 p-2 border rounded-lg font-bold text-sm bg-slate-50 outline-none w-48">
                <option value="">Turnier laden...</option>
            </select>
        </div>
        <div class="flex gap-2">
            <button onclick="save()" class="bg-green-600 text-white px-4 py-2 rounded-xl font-bold uppercase text-[10px]">Speichern</button>
            <button onclick="goLive()" class="bg-orange-500 text-white px-4 py-2 rounded-xl font-bold uppercase text-[10px]">Live Schalten</button>
        </div>
    </div>

    <div id="mainView" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-4" id="schedule"></div>
        
        <div class="bg-slate-900 rounded-3xl p-6 text-white h-fit sticky top-6 shadow-2xl">
            <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-4">Live Tabelle</h2>
            <div id="ranking" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        let cur = null; let curID = "";

        async function init() {
            const { data } = await supabaseClient.from('tournaments').select('id');
            data?.filter(t => t.id !== 'LIVE_CONFIG').forEach(t => document.getElementById('tLoader').add(new Option(t.id, t.id)));
        }

        async function loadTournament(id) {
            if(!id) return;
            curID = id;
            const { data } = await supabaseClient.from('tournaments').select('data').eq('id', id).single();
            cur = data.data;
            document.getElementById('mainView').classList.remove('hidden');
            render();
        }

        function render() {
            const p = cur.p;
            document.getElementById('schedule').innerHTML = cur.s_new.map((r, rI) => `
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b">
                        <span class="font-black uppercase text-blue-600 italic">Runde ${r.id} ${r.time ? ' â€¢ ' + r.time : ''}</span>
                    </div>
                    ${r.matches.map((m, mI) => `
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-1 text-right font-bold text-sm leading-tight">${p[m.team1[0]]}<br>${p[m.team1[1]]}</div>
                            <div class="flex gap-2">
                                <input type="number" value="${m.score[0]}" onchange="cur.s_new[${rI}].matches[${mI}].score[0]=this.value; render();" class="score-input">
                                <input type="number" value="${m.score[1]}" onchange="cur.s_new[${rI}].matches[${mI}].score[1]=this.value; render();" class="score-input">
                            </div>
                            <div class="flex-1 text-left font-bold text-sm leading-tight">${p[m.team2[0]]}<br>${p[m.team2[1]]}</div>
                        </div>
                    `).join('')}
                    <div class="text-[10px] font-bold text-orange-500 uppercase mt-2 bg-orange-50 p-2 rounded-lg">
                        Pause: ${r.pause.map(idx => p[idx]).join(', ') || 'Keiner'}
                    </div>
                </div>
            `).join('');
            updateRanking();
        }

        function updateRanking() {
            let st = cur.p.map(name => ({ name, pts: 0 }));
            cur.s_new.forEach(r => r.matches.forEach(m => {
                if(m.score[0] !== "" && m.score[1] !== "") {
                    const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
                    m.team1.forEach(idx => st[idx].pts += (cur.m==='diff' ? s1-s2 : s1));
                    m.team2.forEach(idx => st[idx].pts += (cur.m==='diff' ? s2-s1 : s2));
                }
            }));
            st.sort((a,b) => b.pts - a.pts);
            document.getElementById('ranking').innerHTML = st.map((s, i) => `
                <div class="flex justify-between items-center bg-slate-800 p-3 rounded-xl">
                    <span class="text-xs font-mono text-slate-500">${i+1}</span>
                    <span class="flex-1 px-3 font-bold text-sm">${s.name}</span>
                    <span class="font-black text-blue-400">${s.pts}</span>
                </div>
            `).join('');
        }

        async function save() {
            await supabaseClient.from('tournaments').upsert({ id: curID, data: cur });
            alert("Gespeichert!");
        }

        async function goLive() {
            await supabaseClient.from('tournaments').upsert({ id: 'LIVE_CONFIG', data: { active_id: curID } });
            alert("Turnier ist jetzt LIVE!");
        }
        init();
    </script>
</body>
</html>
