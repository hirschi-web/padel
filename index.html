<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Pro Cloud Live üéæ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .input-score { width: 45px; text-align: center; border: 2px solid #e2e8f0; border-radius: 6px; padding: 4px; font-weight: bold; }
        .winner { color: #16a34a !important; font-weight: 800; }
        .sync-flash { animation: flash 1s ease-out; }
        @keyframes flash { 0% { background-color: #fef08a; } 100% { background-color: transparent; } }
    </style>
</head>
<body class="bg-slate-50 p-3 max-w-4xl mx-auto text-slate-900">

    <div id="cloudStatus" class="mb-4 p-3 bg-blue-600 text-white rounded-xl shadow-lg flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div id="syncIndicator" class="w-3 h-3 bg-green-400 rounded-full"></div>
            <span class="text-xs font-bold uppercase tracking-widest">Live Cloud Sync</span>
        </div>
        <div class="text-[10px] italic opacity-80" id="lastUpdate">Verbunden</div>
    </div>

    <div class="flex justify-between items-center mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
        <h1 class="text-xl font-black text-slate-800 italic">PADEL PRO</h1>
        <div class="flex gap-2">
            <button onclick="syncData()" class="bg-blue-50 text-blue-600 text-[10px] font-bold px-3 py-2 rounded-lg border border-blue-200 uppercase">Refresh</button>
            <button onclick="resetTournament()" class="bg-red-50 text-red-600 text-[10px] font-bold px-3 py-2 rounded-lg border border-red-200 uppercase">Reset</button>
        </div>
    </div>

    <details class="bg-white rounded-xl shadow-sm border border-slate-200 mb-4 overflow-hidden">
        <summary class="p-4 font-bold text-slate-700 cursor-pointer hover:bg-slate-50 list-none flex justify-between items-center">
            <span>‚öôÔ∏è Turnier-Setup</span>
            <span class="text-[10px] text-blue-500 uppercase font-bold">Einstellungen</span>
        </summary>
        <div class="p-4 bg-slate-50 border-t border-slate-100 space-y-4">
            <div>
                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Turnier-ID (f√ºr Live-Sync):</label>
                <input type="text" id="tournamentId" onchange="initCloud()" class="w-full p-2 border border-slate-300 rounded font-mono text-sm" placeholder="z.B. padel-abend-2024">
            </div>
            <div id="playerInputs" class="grid grid-cols-2 gap-2"></div>
        </div>
    </details>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-4">
            <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-200">
                <select id="playerSelect" onchange="showNextMatch()" class="w-full p-2 rounded bg-slate-100 border-none font-bold outline-none mb-3"></select>
                <div id="nextMatchInfo" class="bg-slate-50 rounded-lg p-3 text-sm min-h-[60px] text-center border border-slate-100"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-200">
                <h2 class="font-bold text-slate-700 mb-4 uppercase text-xs tracking-widest">üìÖ Spielplan</h2>
                <div id="schedule" class="space-y-4"></div>
            </div>
        </div>

        <div class="bg-slate-900 rounded-xl shadow-xl p-4 text-white h-fit md:sticky md:top-4">
            <h2 class="font-bold mb-4 text-blue-400 uppercase text-xs tracking-widest">üèÜ Ranking</h2>
            <table class="w-full text-sm">
                <thead class="text-slate-500 text-[10px] uppercase border-b border-slate-800">
                    <tr><th class="text-left pb-2">Pos</th><th class="text-center pb-2">M</th><th class="text-right pb-2">Pkt</th></tr>
                </thead>
                <tbody id="rankingBody" class="divide-y divide-slate-800"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_KEY = "$2b$10$fV2tM2W6S7IuC8wQ8P6S7.0E1V4N9.B5I6R7B8C9D0E1F2G3H4I5J"; // Demo-Key
        const defaultPlayers = ["Marion", "David", "Martin", "Frank", "Bernhard", "Dieter", "Lucy", "Silvia", "Nik", "Gast"];
        const defaultSchedule = [
            { id: 1, time: "14:05", c2: [0, 1, 2, 3], c3: [4, 5, 6, 7], pause: [8, 9], s2: ["", ""], s3: ["", ""] },
            { id: 2, time: "14:40", c2: [2, 4, 3, 5], c3: [6, 8, 7, 9], pause: [0, 1], s2: ["", ""], s3: ["", ""] },
            { id: 3, time: "15:15", c2: [0, 8, 1, 9], c3: [4, 6, 5, 7], pause: [2, 3], s2: ["", ""], s3: ["", ""] },
            { id: 4, time: "15:50", c2: [0, 2, 7, 8], c3: [1, 3, 6, 9], pause: [4, 5], s2: ["", ""], s3: ["", ""] },
            { id: 5, time: "16:25", c2: [0, 3, 2, 5], c3: [1, 4, 8, 9], pause: [6, 7], s2: ["", ""], s3: ["", ""] }
        ];

        let players = [...defaultPlayers];
        let schedule = JSON.parse(JSON.stringify(defaultSchedule));
        let tId = localStorage.getItem('p_tid') || "mein-padel-turnier";

        // --- CLOUD LOGIK ---
        async function syncData() {
            document.getElementById('syncIndicator').className = 'w-3 h-3 bg-yellow-400 animate-pulse';
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/65b79650dc746540189d6e4a/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const remote = await res.json();
                if (remote.record[tId]) {
                    players = remote.record[tId].p;
                    schedule = remote.record[tId].s;
                    renderAll();
                }
                document.getElementById('syncIndicator').className = 'w-3 h-3 bg-green-400';
                document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
            } catch (e) { console.error("Sync Error", e); }
        }

        async function pushData() {
            document.getElementById('syncIndicator').className = 'w-3 h-3 bg-blue-400 animate-bounce';
            try {
                const res = await fetch(`https://api.jsonbin.io/v3/b/65b79650dc746540189d6e4a/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                let fullDB = (await res.json()).record;
                fullDB[tId] = { p: players, s: schedule };

                await fetch(`https://api.jsonbin.io/v3/b/65b79650dc746540189d6e4a`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
                    body: JSON.stringify(fullDB)
                });
                document.getElementById('syncIndicator').className = 'w-3 h-3 bg-green-400';
            } catch (e) { console.error("Push Error", e); }
        }

        function initCloud() {
            tId = document.getElementById('tournamentId').value || "mein-padel-turnier";
            localStorage.setItem('p_tid', tId);
            syncData();
        }

        // --- UI LOGIK ---
        function updateScore(rIdx, key, tIdx, val) {
            schedule[rIdx][key][tIdx] = val === "" ? "" : parseInt(val);
            renderAll();
            pushData(); // Speichert sofort in der Cloud
        }

        function renderAll() {
            renderPlayers(); renderSchedule(); updateRanking(); showNextMatch();
        }

        // (Restliche Render-Funktionen wie gehabt, nur mit Cloud-Push Anbindung)
        function renderPlayers() {
            document.getElementById('tournamentId').value = tId;
            document.getElementById('playerInputs').innerHTML = players.map((p, i) => `<input type="text" value="${p}" onchange="players[${i}]=this.value; pushData();" class="p-2 border rounded text-xs">`).join('');
            fillPlayerSelect();
        }

        function fillPlayerSelect() {
            const sel = document.getElementById('playerSelect');
            const cur = sel.value;
            sel.innerHTML = '<option value="">Wer bist du?</option>' + players.map((p, i) => `<option value="${i}">${p}</option>`).join('');
            sel.value = cur;
        }

        function showNextMatch() {
            const pIdx = parseInt(document.getElementById('playerSelect').value);
            const info = document.getElementById('nextMatchInfo');
            if (isNaN(pIdx)) { info.innerHTML = "W√§hle einen Namen..."; return; }
            let upcoming = schedule.filter(r => !(r.s2[0] !== "" && r.s2[1] !== "" && (r.c2.includes(pIdx))) && (r.c2.includes(pIdx) || r.c3.includes(pIdx) || r.pause.includes(pIdx))).slice(0, 1);
            if (!upcoming.length) { info.innerHTML = "Fertig! üèÅ"; return; }
            info.innerHTML = `N√§chste Runde: <b>${upcoming[0].time}</b>`;
        }

        function renderSchedule() {
            document.getElementById('schedule').innerHTML = schedule.map((r, rIdx) => `
                <div class="p-3 bg-slate-50 rounded border text-xs mb-2">
                    <div class="flex justify-between mb-2 text-slate-400 font-bold uppercase"><span>R${r.id} | ${r.time}</span></div>
                    ${renderCourt(rIdx, 'c2', 's2', 'C2', r)}
                    <div class="h-[1px] bg-slate-200 my-2"></div>
                    ${renderCourt(rIdx, 'c3', 's3', 'C3', r)}
                </div>`).join('');
        }

        function renderCourt(rIdx, cK, sK, label, r) {
            const s1 = r[sK][0], s2 = r[sK][1], isDone = s1 !== "" && s2 !== "";
            return `<div class="flex items-center gap-2">
                <div class="flex-1 text-right ${isDone && s1 > s2 ? 'winner' : ''}">${players[r[cK][0]]}<br>${players[r[cK][1]]}</div>
                <input type="number" value="${s1}" onchange="updateScore(${rIdx},'${sK}',0,this.value)" class="input-score">
                <span>:</span>
                <input type="number" value="${s2}" onchange="updateScore(${rIdx},'${sK}',1,this.value)" class="input-score">
                <div class="flex-1 text-left ${isDone && s2 > s1 ? 'winner' : ''}">${players[r[cK][2]]}<br>${players[r[cK][3]]}</div>
            </div>`;
        }

        function updateRanking() {
            let stats = players.map((name, id) => ({ name, points: 0, m: 0 }));
            schedule.forEach(r => {
                const add = (pI, s) => { if(s !== "") pI.forEach(idx => { stats[idx].points += s; stats[idx].m++; }); };
                if(r.s2[0]!=="" && r.s2[1]!=="") { add([r.c2[0], r.c2[1]], r.s2[0]); add([r.c2[2], r.c2[3]], r.s2[1]); }
                if(r.s3[0]!=="" && r.s3[1]!=="") { add([r.c3[0], r.c3[1]], r.s3[0]); add([r.c3[2], r.c3[3]], r.s3[1]); }
            });
            stats.sort((a, b) => b.points - a.points);
            document.getElementById('rankingBody').innerHTML = stats.map((s, i) => `<tr><td class="py-2">${i+1}. ${s.name}</td><td class="text-center">${s.m}/5</td><td class="text-right font-bold">${s.points}</td></tr>`).join('');
        }

        function resetTournament() { if(confirm("Cloud-Daten l√∂schen?")) { schedule = JSON.parse(JSON.stringify(defaultSchedule)); pushData(); } }
        
        // Auto-Refresh alle 30 Sekunden
        setInterval(syncData, 30000);
        renderAll();
        syncData();
    </script>
</body>
</html>
