<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Admin - Classic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .score-input { width: 44px; height: 44px; text-align: center; font-size: 1.2rem; font-weight: 900; border: 2px solid #e2e8f0; border-radius: 10px; background: #f8fafc; transition: all 0.2s; }
        .score-input:focus { border-color: #2563eb; outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
        .court-badge { writing-mode: vertical-lr; transform: rotate(180deg); font-size: 9px; font-weight: 900; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-slate-50 p-3 sm:p-6 max-w-6xl mx-auto font-sans text-slate-900">

    <div class="bg-white p-5 rounded-3xl shadow-xl border border-slate-200 mb-6 flex flex-wrap gap-4 justify-between items-center">
        <div>
            <h1 class="text-2xl font-black italic uppercase text-blue-600 tracking-tighter leading-none">Padel Admin</h1>
            <select id="tLoader" onchange="loadTournament(this.value)" class="mt-2 p-2 border rounded-xl font-bold text-xs bg-slate-50 outline-none w-44 cursor-pointer">
                <option value="">Turnier wählen...</option>
            </select>
        </div>
        <div class="flex gap-3">
            <button onclick="save()" class="bg-green-600 text-white px-5 py-2.5 rounded-2xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-all">Speichern</button>
            <button onclick="goLive()" class="bg-orange-500 text-white px-5 py-2.5 rounded-2xl font-black uppercase text-[10px] shadow-lg active:scale-95 transition-all">Live schalten</button>
        </div>
    </div>

    <div id="editWrapper" class="hidden mb-6">
        <details class="bg-white rounded-[2rem] shadow-md border border-slate-200 overflow-hidden">
            <summary class="p-4 font-black text-[10px] uppercase tracking-widest text-slate-400 cursor-pointer hover:bg-slate-50 flex justify-between items-center">
                <span>⚙️ Ranking-Modus & Spielernamen anpassen</span>
                <span class="text-blue-600 underline">Öffnen</span>
            </summary>
            <div class="p-6 border-t border-slate-100 bg-slate-50/50 space-y-6">
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2">Berechnung Live-Ranking</label>
                    <select id="scoringMode" onchange="cur.m = this.value; updateRanking();" class="p-3 border rounded-xl font-bold text-sm bg-white outline-none w-full sm:w-64">
                        <option value="total">Erzielte Punkte (Total)</option>
                        <option value="diff">Punktedifferenz (Plus/Minus)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-black uppercase text-slate-400 mb-2">Spielernamen korrigieren</label>
                    <div id="playerEditGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>
            </div>
        </details>
    </div>

    <div id="mainView" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8 space-y-6" id="schedule"></div>
        
        <div class="lg:col-span-4 h-fit sticky top-6">
            <div class="bg-slate-900 rounded-[2rem] p-6 text-white shadow-2xl border-b-8 border-blue-600">
                <h2 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-6 flex justify-between">
                    <span>Live Ranking</span>
                    <span id="activeTournamentName" class="text-blue-500 italic"></span>
                </h2>
                <div id="ranking" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        let cur = null; let curID = "";

        async function init() {
            const { data } = await supabaseClient.from('tournaments').select('id');
            data?.filter(t => t.id !== 'LIVE_CONFIG').forEach(t => document.getElementById('tLoader').add(new Option(t.id, t.id)));
        }

        async function loadTournament(id) {
            if(!id) return;
            curID = id;
            const { data } = await supabaseClient.from('tournaments').select('data').eq('id', id).single();
            cur = data.data;
            if(!cur.m) cur.m = 'total';
            
            document.getElementById('activeTournamentName').innerText = id;
            document.getElementById('editWrapper').classList.remove('hidden');
            document.getElementById('mainView').classList.remove('hidden');
            
            // Edit-Bereich vorbereiten
            document.getElementById('scoringMode').value = cur.m;
            renderPlayerEdits();
            render();
        }

        function renderPlayerEdits() {
            document.getElementById('playerEditGrid').innerHTML = cur.p.map((name, i) => `
                <input type="text" value="${name}" 
                    oninput="cur.p[${i}]=this.value; render();" 
                    class="p-2 border rounded-lg font-bold text-xs bg-white outline-none focus:border-blue-500">
            `).join('');
        }

        function render() {
            const p = cur.p;
            document.getElementById('schedule').innerHTML = cur.s_new.map((r, rI) => `
                <div class="bg-white rounded-[2rem] shadow-md border border-slate-200 overflow-hidden flex">
                    <div class="w-12 bg-blue-600 flex flex-col items-center justify-center text-white border-r">
                        <span class="court-badge uppercase opacity-50 tracking-tighter">Runde</span>
                        <span class="font-black text-xl mt-1">${r.id}</span>
                    </div>
                    <div class="flex-1 p-5">
                        <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                            <span class="font-black uppercase text-slate-400 text-[10px] tracking-widest">${r.time ? r.time + ' Uhr' : 'Match ' + r.id}</span>
                            <span class="text-[10px] font-black text-orange-500 uppercase italic">Pause: ${r.pause.map(idx => p[idx]).join(', ') || 'Keiner'}</span>
                        </div>
                        <div class="space-y-4">
                            ${r.matches.map((m, mI) => `
                                <div class="flex items-center gap-4 bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                    <div class="w-8 text-[9px] font-black text-slate-300 italic">C${m.court}</div>
                                    <div class="flex-1 text-right font-bold text-sm leading-tight text-slate-700">
                                        ${p[m.team1[0]]}<br>${p[m.team1[1]]}
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="number" value="${m.score[0]}" onchange="cur.s_new[${rI}].matches[${mI}].score[0]=this.value; updateRanking();" class="score-input">
                                        <input type="number" value="${m.score[1]}" onchange="cur.s_new[${rI}].matches[${mI}].score[1]=this.value; updateRanking();" class="score-input">
                                    </div>
                                    <div class="flex-1 text-left font-bold text-sm leading-tight text-slate-700">
                                        ${p[m.team2[0]]}<br>${p[m.team2[1]]}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            updateRanking();
        }

        function updateRanking() {
            let st = cur.p.map(name => ({ name, pts: 0 }));
            cur.s_new.forEach(r => r.matches.forEach(m => {
                if(m.score[0] !== "" && m.score[1] !== "") {
                    const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
                    m.team1.forEach(idx => st[idx].pts += (cur.m==='diff' ? s1-s2 : s1));
                    m.team2.forEach(idx => st[idx].pts += (cur.m==='diff' ? s2-s1 : s2));
                }
            }));
            st.sort((a,b) => b.pts - a.pts);
            document.getElementById('ranking').innerHTML = st.map((s, i) => `
                <div class="flex justify-between items-center bg-white/5 p-4 rounded-2xl border border-white/10">
                    <span class="text-xs font-black text-blue-500 w-6">${i+1}</span>
                    <span class="flex-1 px-3 font-bold text-sm">${s.name}</span>
                    <span class="font-black text-blue-400 text-lg">${s.pts}</span>
                </div>
            `).join('');
        }

        async function save() {
            await supabaseClient.from('tournaments').upsert({ id: curID, data: cur });
            alert("Gespeichert!");
        }

        async function goLive() {
            await supabaseClient.from('tournaments').upsert({ id: 'LIVE_CONFIG', data: { active_id: curID } });
            alert("Turnier ist jetzt LIVE!");
        }
        init();
    </script>
</body>
</html>
