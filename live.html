<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padel Turnier - Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .match-card { background: white; border-radius: 1.5rem; border: 1px solid #e2e8f0; transition: all 0.3s; }
        .match-active { border: 2px solid #3b82f6; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2); }
        .score-display { width: 3.5rem; height: 3.5rem; text-align: center; font-size: 1.5rem; font-weight: 900; background: #f1f5f9; border-radius: 0.75rem; border: none; outline: none; color: #1e293b; -webkit-appearance: none; appearance: none; }
        .highlight-name { color: #ef4444 !important; font-weight: 900; font-size: 1rem; }
        .prediction-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); color: white; border-radius: 1.5rem; }
        details summary::-webkit-details-marker { display: none; }
        .refresh-btn { transition: transform 0.3s ease; }
        .refresh-btn:active { transform: rotate(180deg); }
    </style>
</head>
<body class="p-3 sm:p-6 max-w-2xl mx-auto pb-20 text-slate-800">

    <header class="mb-6">
        <div class="flex justify-between items-start mb-4">
            <h1 id="tournamentTitle" class="text-3xl font-black text-blue-600 uppercase italic tracking-tighter">Lade...</h1>
            <button onclick="fetchLive()" class="refresh-btn bg-white p-3 rounded-full shadow-sm border border-slate-200 text-xl" title="Aktualisieren">üîÑ</button>
        </div>
        <div class="mt-4">
            <label class="text-[12px] font-bold uppercase text-slate-400 block mb-1 font-mono text-center font-bold">Spieler Fokus</label>
            <select id="userSelect" onchange="saveUserSelection()" class="w-full p-4 rounded-xl border-2 border-blue-100 font-bold bg-white shadow-sm focus:border-blue-500 outline-none text-lg">
                <option value="">-- Wer bist du? --</option>
            </select>
        </div>
    </header>

    <div id="nextMatchesContainer" class="mb-8 hidden">
        <h2 class="text-sm font-black uppercase text-blue-500 mb-3 flex items-center gap-2">
            <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
            </span>
            Deine n√§chsten Spiele
        </h2>
        <div id="nextMatchesList" class="space-y-3"></div>
    </div>

    <div id="scheduleContainer" class="space-y-10"></div>

    <hr class="my-10 border-slate-200">

    <section class="mb-10">
        <h2 class="text-2xl font-black uppercase italic mb-4 flex items-center gap-2">üèÜ Live Ranking</h2>
        <div class="bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
            <table class="w-full text-left">
                <thead class="bg-slate-900 text-white text-[12px] uppercase tracking-widest">
                    <tr><th class="p-4">Spieler</th><th class="p-4 text-center">Pkt</th><th class="p-4 text-center">Diff</th></tr>
                </thead>
                <tbody id="rankingBody" class="font-bold text-base"></tbody>
            </table>
        </div>
    </section>

    <details id="predictionSection" class="hidden border-t border-slate-200 pt-6">
        <summary class="list-none cursor-pointer">
            <div class="prediction-card p-6 shadow-2xl relative overflow-hidden group">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-black uppercase italic tracking-wide text-blue-400">Padel-Bot Analyse</h3>
                        <p class="text-[12px] text-slate-400 uppercase font-bold">Trend & Prognose</p>
                    </div>
                    <span class="text-3xl transition-transform group-open:rotate-180">ü§ñ</span>
                </div>
                <div id="predictionContent" class="mt-4 space-y-4 text-base font-medium leading-relaxed border-t border-slate-700 pt-4"></div>
            </div>
        </summary>
    </details>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        let tData = null;
        let currentT_ID = null;

        function saveUserSelection() {
            const val = document.getElementById('userSelect').value;
            localStorage.setItem('padel_focus_user', val);
            updateView();
        }

        async function fetchLive() {
            try {
                const { data: config } = await supabaseClient.from('tournaments').select('data').eq('id', 'LIVE_CONFIG').single();
                if(!config) return;
                const activeID = config.data.active_id;
                const { data } = await supabaseClient.from('tournaments').select('data').eq('id', activeID).single();
                if (data) {
                    currentT_ID = activeID;
                    tData = data.data;
                    document.getElementById('tournamentTitle').innerText = activeID.replace(/_/g, ' ');
                    fillUserSelect();
                    updateView();
                }
            } catch (e) { console.error(e); }
        }

        function fillUserSelect() {
            const select = document.getElementById('userSelect');
            const savedUser = localStorage.getItem('padel_focus_user');
            const currentVal = select.value || savedUser; 
            select.innerHTML = '<option value="">-- Wer bist du? --</option>';
            const players = tData.p.filter(name => name && !name.includes("Gegner"));
            players.forEach(name => {
                let opt = document.createElement('option');
                opt.value = name;
                opt.innerText = name;
                if(name === currentVal) opt.selected = true;
                select.appendChild(opt);
            });
        }

        function updateView() {
            renderSchedule();
            calculateRanking();
            showNextMatches();
            calculatePrediction();
        }

        function renderSchedule() {
            const focusName = document.getElementById('userSelect').value;
            const container = document.getElementById('scheduleContainer');
            if(!tData) return;
            
            container.innerHTML = tData.s_new.map((round, rIdx) => `
                <div class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <span class="text-[13px] font-black uppercase text-slate-400 italic font-bold">Runde ${round.id}</span>
                    </div>
                    ${round.matches.map((m, mIdx) => {
                        const p1=tData.p[m.team1[0]], p2=tData.p[m.team1[1]], p3=tData.p[m.team2[0]], p4=tData.p[m.team2[1]];
                        const isMyMatch = focusName && (p1===focusName || p2===focusName || p3===focusName || p4===focusName);
                        return `
                        <div class="match-card p-5 ${isMyMatch ? 'match-active' : ''}">
                            <div class="flex items-center justify-between gap-2">
                                <div class="flex-1 text-center text-[15px] leading-tight font-bold ${focusName && (p1===focusName || p2===focusName) ? 'highlight-name' : ''}">
                                    ${p1}<br>${p2}
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="text" value="${m.score[0] || ''}" class="score-display font-bold" readonly placeholder="-">
                                    <span class="text-slate-300 font-black text-xl">:</span>
                                    <input type="text" value="${m.score[1] || ''}" class="score-display font-bold" readonly placeholder="-">
                                </div>
                                <div class="flex-1 text-center text-[15px] leading-tight font-bold ${focusName && (p3===focusName || p4===focusName) ? 'highlight-name' : ''}">
                                    ${p3}<br>${p4}
                                </div>
                            </div>
                            <div class="text-center text-[11px] mt-3 text-slate-300 font-bold uppercase tracking-tighter">Court ${m.court}</div>
                        </div>`;
                    }).join('')}
                </div>
            `).join('');
        }

        function showNextMatches() {
            const focusName = document.getElementById('userSelect').value;
            const container = document.getElementById('nextMatchesContainer');
            if (!focusName || !tData) { container.classList.add('hidden'); return; }

            const next = [];
            tData.s_new.forEach(round => {
                round.matches.forEach(m => {
                    const p = [tData.p[m.team1[0]], tData.p[m.team1[1]], tData.p[m.team2[0]], tData.p[m.team2[1]]];
                    if (p.includes(focusName) && (m.score[0] === "" || m.score[0] === null) && next.length < 2) {
                        const partner = (p[0] === focusName) ? p[1] : (p[1] === focusName) ? p[0] : (p[2] === focusName) ? p[3] : p[2];
                        const opps = (p.slice(0,2).includes(focusName)) ? [p[2], p[3]] : [p[0], p[1]];
                        next.push(`R${round.id} / C${m.court} mit <span class="text-blue-600">${partner}</span> vs. <span class="text-slate-600">${opps.join(' & ')}</span>`);
                    }
                });
            });

            if (next.length > 0) {
                container.classList.remove('hidden');
                document.getElementById('nextMatchesList').innerHTML = next.map(text => `<div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-[15px] font-bold shadow-sm">${text}</div>`).join('');
            } else { container.classList.add('hidden'); }
        }

        function calculateRanking() {
            if(!tData) return [];
            let stats = tData.p.map(name => ({ name, points: 0, diff: 0, games: 0 }));
            tData.s_new.forEach(r => r.matches.forEach(m => {
                const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
                if (!isNaN(s1) && !isNaN(s2)) {
                    m.team1.forEach(i => { stats[i].points += s1; stats[i].diff += (s1-s2); stats[i].games++; });
                    m.team2.forEach(i => { stats[i].points += s2; stats[i].diff += (s2-s1); stats[i].games++; });
                }
            }));
            const filtered = stats.filter(s => !s.name.includes("Gegner")).sort((a,b) => b.points - a.points || b.diff - a.diff);
            const focus = document.getElementById('userSelect').value;
            document.getElementById('rankingBody').innerHTML = filtered.map((s, i) => `
                <tr class="border-b border-slate-50 ${s.name === focus ? 'bg-blue-50' : ''}">
                    <td class="p-4 flex items-center gap-3">
                        <span class="text-[11px] text-slate-300 font-mono font-bold">${i+1}.</span>
                        <span class="text-base font-bold ${s.name === focus ? 'highlight-name' : ''}">${s.name}</span>
                    </td>
                    <td class="p-4 text-center text-blue-600 font-black text-lg">${s.points}</td>
                    <td class="p-4 text-center text-sm font-bold ${s.diff>=0?'text-green-500':'text-red-400'}">${s.diff>0?'+':''}${s.diff}</td>
                </tr>`).join('');
            return stats;
        }

        function calculatePrediction() {
            const focus = document.getElementById('userSelect').value;
            const section = document.getElementById('predictionSection');
            if (!focus || !tData) { section.classList.add('hidden'); return; }

            const stats = calculateRanking(); 
            const completedRounds = tData.s_new.filter(r => r.matches.every(m => m.score[0] !== "" && m.score[0] !== null)).length;

            if (completedRounds < 2) {
                section.classList.remove('hidden');
                document.getElementById('predictionContent').innerHTML = `<p class="text-slate-400 italic text-sm text-center py-4">ü§ñ Padel-Bot sammelt Daten... <br>Analyse startet nach Runde 2.</p>`;
                return;
            }

            section.classList.remove('hidden');

            const getTrendData = (playerName) => {
                let scores = [];
                tData.s_new.forEach(r => r.matches.forEach(m => {
                    const pNames = [tData.p[m.team1[0]], tData.p[m.team1[1]], tData.p[m.team2[0]], tData.p[m.team2[1]]];
                    if (pNames.includes(playerName) && m.score[0] !== "" && m.score[0] !== null) {
                        const s = (tData.p[m.team1[0]] === playerName || tData.p[m.team1[1]] === playerName) ? parseInt(m.score[0]) : parseInt(m.score[1]);
                        scores.push(s);
                    }
                }));
                const last = scores.length > 0 ? scores[scores.length - 1] : 0;
                const prev = scores.length > 1 ? scores[scores.length - 2] : last;
                let symbol = "‚û°Ô∏è";
                let val = 0;
                if (last > prev + 2) { symbol = "‚ÜóÔ∏è"; val = 1; }
                else if (last < prev - 2) { symbol = "‚ÜòÔ∏è"; val = -1; }
                return { symbol, val };
            };

            const getRank = (playerName) => {
                const sorted = stats.filter(s => !s.name.includes("Gegner")).sort((a,b) => b.points - a.points || b.diff - a.diff);
                return sorted.findIndex(s => s.name === playerName) + 1;
            };

            let nextMatchContent = "";
            const sortedStats = stats.filter(s => !s.name.includes("Gegner")).sort((a,b) => b.points - a.points || b.diff - a.diff);
            const myIdx = sortedStats.findIndex(s => s.name === focus);
            const targetPlayer = myIdx > 0 ? sortedStats[myIdx - 1] : null;

            tData.s_new.forEach(round => {
                round.matches.forEach(m => {
                    const p = [tData.p[m.team1[0]], tData.p[m.team1[1]], tData.p[m.team2[0]], tData.p[m.team2[1]]];
                    if (p.includes(focus) && (m.score[0] === "" || m.score[0] === null) && nextMatchContent === "") {
                        const isTeam1 = p.slice(0,2).includes(focus);
                        const partner = isTeam1 ? (p[0] === focus ? p[1] : p[0]) : (p[2] === focus ? p[3] : p[2]);
                        const opps = isTeam1 ? [p[2], p[3]] : [p[0], p[1]];
                        
                        const trendMe = getTrendData(focus);
                        const trendPartner = getTrendData(partner);
                        const trendO1 = getTrendData(opps[0]);
                        const trendO2 = getTrendData(opps[1]);

                        const rankMe = getRank(focus);
                        const rankP = getRank(partner);
                        const rankO1 = getRank(opps[0]);
                        const rankO2 = getRank(opps[1]);

                        // REALISTISCHE LOGIK
                        const teamAvgRank = (rankMe + rankP) / 2;
                        const oppAvgRank = (rankO1 + rankO2) / 2;
                        const trendDiff = (trendMe.val + trendPartner.val) - (trendO1.val + trendO2.val);
                        
                        let rating = "Machbar";
                        let rColor = "text-blue-400";
                        if (oppAvgRank < teamAvgRank - 2.5) { rating = "Harte Nuss"; rColor = "text-red-400"; }
                        else if (oppAvgRank > teamAvgRank + 2.5 || trendDiff >= 2) { rating = "Favorit / Easy"; rColor = "text-green-400"; }

                        let caution = "";
                        if (trendO1.val === 1 || trendO2.val === 1) {
                            caution = `<div class="bg-amber-500/10 border border-amber-500/30 p-3 rounded-xl mb-3 flex items-center gap-3">
                                <span class="text-xl">‚ö†Ô∏è</span>
                                <div class="text-[11px] leading-tight text-amber-200 uppercase font-bold text-left">Achtung: Gegner im Formhoch!</div>
                            </div>`;
                        }

                        nextMatchContent = `
                            ${caution}
                            <div class="bg-slate-800/80 p-4 rounded-xl border border-slate-700">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Team Check</span>
                                    <span class="${rColor} text-[11px] font-black uppercase italic">${rating}</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-xs font-bold">
                                    <div class="space-y-2 border-r border-slate-700/50 pr-2">
                                        <div class="flex justify-between text-slate-300"><span>Du (${rankMe}.)</span> <span>${trendMe.symbol}</span></div>
                                        <div class="flex justify-between text-slate-300"><span>Partner (${rankP}.)</span> <span>${trendPartner.symbol}</span></div>
                                    </div>
                                    <div class="space-y-2 pl-2">
                                        <div class="flex justify-between text-slate-300"><span>Gegner 1 (${rankO1}.)</span> <span>${trendO1.symbol}</span></div>
                                        <div class="flex justify-between text-slate-300"><span>Gegner 2 (${rankO2}.)</span> <span>${trendO2.symbol}</span></div>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
            });

            let mission = "";
            if (targetPlayer) {
                const diff = targetPlayer.points - stats.find(s => s.name === focus).points;
                mission = `<div class="bg-green-500/10 border border-green-500/30 p-3 rounded-xl mt-3 text-center">
                    <p class="text-xs text-green-400 font-bold italic">üöÄ Mission: +${diff + 1} Pkt. mehr als ${targetPlayer.name} f√ºr Platz ${myIdx}!</p>
                </div>`;
            }

            document.getElementById('predictionContent').innerHTML = `
                <div class="space-y-4">
                    ${nextMatchContent}
                    ${mission}
                    <p class="text-[9px] text-slate-500 text-center uppercase tracking-widest font-black pt-2">Analyse-Modus: Aktiv (Runde ${completedRounds})</p>
                </div>`;
        }

        fetchLive();
        setInterval(fetchLive, 10000);
    </script>
</body>
</html>
