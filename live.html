<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Padel Hirsch">
    <meta name="theme-color" content="#0f172a">
    <title>Padel Hirsch ‚Äì Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080e1a;
            --bg-card: rgba(255,255,255,0.04);
            --bg-card-solid: #111827;
            --border: rgba(255,255,255,0.08);
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            --accent: #3b82f6;
            --accent-glow: rgba(59,130,246,0.25);
            --gold: #fbbf24;
            --green: #22c55e;
            --red: #ef4444;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        body {
            font-family:'Outfit',sans-serif; background:var(--bg); color:var(--text);
            min-height:100vh; min-height:100dvh;
            padding-top:var(--safe-top); padding-bottom:calc(var(--safe-bottom) + 120px);
            overflow-x:hidden; -webkit-font-smoothing:antialiased;
        }
        body::before {
            content:''; position:fixed; top:0; left:0; right:0; height:400px;
            background:radial-gradient(ellipse at 50% 0%, rgba(59,130,246,0.12) 0%, transparent 70%);
            pointer-events:none; z-index:0;
        }
        .container { max-width:430px; margin:0 auto; padding:0 20px; position:relative; z-index:1; }

        .card {
            background:var(--bg-card); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
            border:1px solid var(--border); border-radius:24px;
            transition:all 0.3s cubic-bezier(0.4,0,0.2,1);
        }
        .card-solid { background:var(--bg-card-solid); border:1px solid var(--border); border-radius:22px; }
        .card-focus {
            border-color:var(--accent) !important;
            box-shadow:0 0 0 1px var(--accent), 0 12px 40px var(--accent-glow);
            transform:scale(1.02); z-index:10; position:relative;
        }

        .score-box {
            width:56px; height:56px; text-align:center; border-radius:14px;
            font-family:'Space Mono',monospace; font-weight:700; font-size:24px;
            color:var(--text); background:rgba(255,255,255,0.06);
            border:2px solid var(--border); transition:all 0.25s;
            -webkit-appearance:none;
        }
        .score-box:disabled { background:transparent; border-color:transparent; opacity:1; }
        .is-editing .score-box:not(:disabled) {
            background:rgba(59,130,246,0.15); border-color:var(--accent);
            box-shadow:0 0 20px var(--accent-glow);
        }

        .text-focus { color:var(--gold) !important; font-weight:800; }
        .rank-gold { background:rgba(251,191,36,0.08) !important; }

        @keyframes pulseLive { 0%,100%{opacity:1;box-shadow:0 0 8px var(--accent)} 50%{opacity:0.4;box-shadow:none} }
        .pulse-live { animation:pulseLive 2s ease-in-out infinite; }
        .anim-in { animation: fadeUp 0.5s ease-out both; }
        @keyframes fadeUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }

        .focus-select {
            width:100%; padding:16px 20px; background:var(--bg-card-solid);
            border:2px solid var(--border); border-radius:18px;
            font-family:'Outfit',sans-serif; font-weight:700; font-size:16px;
            color:var(--text); outline:none; appearance:none; -webkit-appearance:none;
            background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position:right 16px center; background-repeat:no-repeat; background-size:20px;
        }

        .save-toast {
            position:fixed; bottom:calc(var(--safe-bottom) + 30px); left:50%;
            transform:translateX(-50%) translateY(100px); z-index:999;
            transition:transform 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.4s;
            opacity:0;
        }
        .save-toast.show { transform:translateX(-50%) translateY(0); opacity:1; }

        .round-divider { display:flex; align-items:center; gap:12px; }
        .round-divider::after { content:''; flex:1; height:1px; background:var(--border); }
    </style>
</head>
<body>

<div class="container">
    <header class="flex justify-between items-center pt-8 pb-2 anim-in">
        <div class="flex items-center gap-4">
            <svg width="48" height="48" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="96" fill="#0f172a"/>
                <ellipse cx="100" cy="88" rx="34" ry="38" fill="#3b82f6" opacity="0.8"/>
                <path d="M100 52 L100 36 M88 22 C85 18 82 15 80 11 M112 22 C115 18 118 15 120 11" stroke="white" stroke-width="4" stroke-linecap="round"/>
                <circle cx="124" cy="72" r="6" fill="#fbbf24"/>
            </svg>
            <div>
                <div class="text-[10px] font-800 uppercase tracking-[0.4em] text-[var(--text-dim)]">Padel Hirsch</div>
                <h1 id="tournamentTitle" class="text-2xl font-900 uppercase tracking-tight leading-none text-white">Lade...</h1>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="location.reload()" class="w-12 h-12 flex items-center justify-center card text-lg">üîÑ</button>
            <button id="lockBtn" onclick="toggleEditMode()" class="w-12 h-12 flex items-center justify-center card text-lg">üîí</button>
        </div>
    </header>

    <div id="liveIndicator" class="flex items-center gap-2.5 mt-4 mb-8 anim-in" style="display:none;">
        <div class="w-2 h-2 rounded-full bg-[var(--accent)] pulse-live"></div>
        <span class="text-[10px] font-800 uppercase tracking-[0.3em] text-[var(--text-muted)]">Live Scoreboard</span>
    </div>

    <div id="errorState" style="display:none;" class="flex flex-col items-center justify-center min-h-[50vh] text-center gap-4">
        <div class="text-6xl">ü¶å</div>
        <h2 class="text-xl font-800 text-white">Turnier nicht gefunden</h2>
    </div>

    <div id="mainContent" style="display:none;">
        <div class="mb-10 anim-in">
            <label class="block text-[10px] font-800 uppercase tracking-[0.3em] text-[var(--text-dim)] mb-3 ml-1">Dein Fokus</label>
            <select id="playerFocus" onchange="onFocusChange()" class="focus-select">
                <option value="">‚Äì W√§hle deinen Namen / Team ‚Äì</option>
            </select>
        </div>

        <div id="scheduleArea" class="space-y-8"></div>

        <div class="mt-16 anim-in">
            <div class="round-divider mb-6">
                <span class="text-[11px] font-900 uppercase tracking-[0.25em] text-[var(--text-muted)]">üèÜ Ranking</span>
            </div>
            <div class="card-solid overflow-hidden shadow-2xl">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[9px] uppercase tracking-[0.25em] text-[var(--text-dim)] border-b border-[var(--border)]">
                            <th class="py-4 pl-6 pr-2">#</th>
                            <th class="py-4 px-2">Teilnehmer</th>
                            <th class="py-4 px-2 text-center">W/L</th>
                            <th class="py-4 px-2 text-center">Pkt</th>
                            <th class="py-4 pl-2 pr-6 text-center">Diff</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="saveToast" class="save-toast">
    <button id="saveToastBtn" onclick="saveCurrentMatch()" class="bg-blue-600 text-white px-10 py-4 rounded-full font-900 text-sm uppercase tracking-widest shadow-2xl flex items-center gap-3 transition-all active:scale-90">
        <span>‚úì SPEICHERN</span>
    </button>
</div>

<script>
const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

let tournamentId = "";
let tournamentData = null;
let isEditing = false;
let pendingMatch = null;

function parseTournamentId() {
    const params = new URLSearchParams(window.location.search);
    let id = params.get('id');
    if (!id) {
        const raw = window.location.search.substring(1);
        if (raw) id = decodeURIComponent(raw).split('&')[0].split('=')[0];
    }
    return id ? id.replace(/\/$/, '') : ''; 
}

async function init() {
    tournamentId = parseTournamentId();
    if (!tournamentId) { showError(); return; }
    
    try {
        const { data, error } = await supabaseClient.from('tournaments').select('*').eq('id', tournamentId);
        if (error || !data || data.length === 0) { showError(); return; }
        
        tournamentData = data[0].data;
        document.getElementById('tournamentTitle').innerText = tournamentId.toUpperCase();
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('liveIndicator').style.display = 'flex';
        
        if (sessionStorage.getItem('isAdmin_'+tournamentId) === 'true') {
            isEditing = true;
            document.getElementById('lockBtn').innerText = "üîì";
            document.body.classList.add('is-editing');
        }
        
        populateFocusSelect();
        renderAll();
        setupRealtime();
    } catch(e) { showError(); }
}

function showError() {
    document.getElementById('errorState').style.display = 'flex';
    document.getElementById('tournamentTitle').innerText = '‚Äî';
}

function populateFocusSelect() {
    const sel = document.getElementById('playerFocus');
    const saved = localStorage.getItem('focus_'+tournamentId);
    if (tournamentData.type === 'team') {
        for (let i = 0; i < tournamentData.p.length; i += 2) {
            const n = `${tournamentData.p[i]} + ${tournamentData.p[i+1]}`;
            sel.add(new Option(n, n));
        }
    } else {
        tournamentData.p.forEach(n => sel.add(new Option(n, n)));
    }
    if (saved) sel.value = saved;
}

function onFocusChange() {
    const v = document.getElementById('playerFocus').value;
    if(v) localStorage.setItem('focus_'+tournamentId, v);
    else localStorage.removeItem('focus_'+tournamentId);
    renderAll();
}

function setupRealtime() {
    supabaseClient.channel('t-' + tournamentId)
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tournaments', filter: `id=eq.${tournamentId}` },
            (payload) => { tournamentData = payload.new.data; renderAll(); })
        .subscribe();
}

function toggleEditMode() {
    if (!isEditing) {
        const pw = prompt("Admin Passwort:");
        if (pw && pw === tournamentData.pw) {
            isEditing = true;
            sessionStorage.setItem('isAdmin_'+tournamentId, 'true');
            document.getElementById('lockBtn').innerText = "üîì";
            document.body.classList.add('is-editing');
            renderAll();
        }
    } else {
        isEditing = false;
        sessionStorage.removeItem('isAdmin_'+tournamentId);
        document.getElementById('lockBtn').innerText = "üîí";
        document.body.classList.remove('is-editing');
        hideSaveToast();
        renderAll();
    }
}

function showSaveToast(rIdx, mIdx) {
    pendingMatch = {rIdx, mIdx};
    document.getElementById('saveToast').classList.add('show');
}
function hideSaveToast() {
    pendingMatch = null;
    document.getElementById('saveToast').classList.remove('show');
}

async function saveCurrentMatch() {
    if (!pendingMatch) return;
    const {rIdx, mIdx} = pendingMatch;
    const v0 = document.getElementById(`score-${rIdx}-${mIdx}-0`).value.trim();
    const v1 = document.getElementById(`score-${rIdx}-${mIdx}-1`).value.trim();

    if (v0 === '' && v1 === '') {
        tournamentData.s_new[rIdx].matches[mIdx].score = ["", ""];
    } else {
        tournamentData.s_new[rIdx].matches[mIdx].score = [v0, v1];
    }

    try {
        await supabaseClient.from('tournaments').update({data: tournamentData}).eq('id', tournamentId);
        hideSaveToast();
        renderAll();
    } catch(e) { alert("Fehler beim Speichern."); }
}

function renderAll() {
    const focus = document.getElementById('playerFocus').value;
    const area = document.getElementById('scheduleArea');
    const isTeam = tournamentData.type === 'team';
    let html = '';

    tournamentData.s_new.forEach((round, rIdx) => {
        html += `<div class="anim-in">`;
        html += `<div class="round-divider mb-4"><span class="text-[11px] font-900 uppercase tracking-[0.2em] text-[var(--text-muted)]">Runde ${round.id} ¬∑ ${round.time} Uhr</span></div><div class="space-y-4">`;

        round.matches.forEach((m, mIdx) => {
            const t1N = isTeam ? `${tournamentData.p[m.team1[0]]} + ${tournamentData.p[m.team1[1]]}` : tournamentData.p[m.team1[0]];
            const t2N = isTeam ? `${tournamentData.p[m.team2[0]]} + ${tournamentData.p[m.team2[1]]}` : tournamentData.p[m.team2[0]];
            const s0 = m.score ? m.score[0] : "";
            const s1 = m.score ? m.score[1] : "";
            const hasScore = s0 !== "" && s0 !== null;
            
            let w = 0;
            if (hasScore) {
                if (parseInt(s0) > parseInt(s1)) w = 1; else if (parseInt(s1) > parseInt(s0)) w = 2;
            }

            const chk = (pIdx) => (focus && (tournamentData.p[pIdx] === focus || (isTeam && (focus === t1N && m.team1.includes(pIdx) || focus === t2N && m.team2.includes(pIdx))))) ? 'text-focus' : '';

            html += `
            <div class="card p-5 ${focus && (focus === t1N || focus === t2N) ? 'card-focus' : ''}">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-[9px] font-900 uppercase tracking-widest text-[var(--text-dim)]">Court ${m.court || (mIdx + 1)}</span>
                    ${hasScore ? '<span class="text-[10px] text-[var(--green)] font-900">‚úì LIVE</span>' : '<span class="text-[10px] text-[var(--text-dim)] font-700">OFFEN</span>'}
                </div>
                <div class="flex justify-between items-center gap-2">
                    <div class="flex-1 min-w-0 ${w === 1 || !hasScore ? '' : 'opacity-40'}">
                        <div class="text-[15px] font-900 uppercase truncate ${chk(m.team1[0])}">${tournamentData.p[m.team1[0]]}</div>
                        ${m.team1[1] !== undefined ? `<div class="text-[13px] font-700 uppercase truncate text-[var(--text-muted)] ${chk(m.team1[1])}">${tournamentData.p[m.team1[1]]}</div>` : ''}
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="score-${rIdx}-${mIdx}-0" type="number" value="${s0}" ${!isEditing ? 'disabled' : ''} oninput="showSaveToast(${rIdx},${mIdx})" class="score-box">
                        <span class="text-[var(--text-dim)] font-900 text-xl">:</span>
                        <input id="score-${rIdx}-${mIdx}-1" type="number" value="${s1}" ${!isEditing ? 'disabled' : ''} oninput="showSaveToast(${rIdx},${mIdx})" class="score-box">
                    </div>
                    <div class="flex-1 text-right min-w-0 ${w === 2 || !hasScore ? '' : 'opacity-40'}">
                        <div class="text-[15px] font-900 uppercase truncate ${chk(m.team2[0])}">${tournamentData.p[m.team2[0]]}</div>
                        ${m.team2[1] !== undefined ? `<div class="text-[13px] font-700 uppercase truncate text-[var(--text-muted)] ${chk(m.team2[1])}">${tournamentData.p[m.team2[1]]}</div>` : ''}
                    </div>
                </div>
            </div>`;
        });
        html += `</div></div>`;
    });
    area.innerHTML = html;
    updateRanking();
}

function updateRanking() {
    const isTeam = tournamentData.type === 'team';
    let stats = [];
    if(isTeam){for(let i=0;i<tournamentData.p.length;i+=2) stats.push({name:`${tournamentData.p[i]} + ${tournamentData.p[i+1]}`,ids:[i,i+1],points:0,diff:0,wins:0,losses:0});}
    else{stats=tournamentData.p.map((n,i)=>({name:n,ids:[i],points:0,diff:0,wins:0,losses:0}));}

    tournamentData.s_new.forEach(r => {
        r.matches.forEach(m => {
            if(m.score && m.score[0] !== "" && m.score[0] !== null){
                const s1 = parseInt(m.score[0]); const s2 = parseInt(m.score[1]);
                stats.forEach(e => {
                    if(e.ids.some(id => m.team1.includes(id))){
                        e.points += s1; e.diff += (s1 - s2); if(s1 > s2) e.wins++; else if(s2 > s1) e.losses++;
                    }
                    if(e.ids.some(id => m.team2.includes(id))){
                        e.points += s2; e.diff += (s2 - s1); if(s2 > s1) e.wins++; else if(s1 > s2) e.losses++;
                    }
                });
            }
        });
    });

    stats.sort((a,b) => b.points - a.points || b.diff - a.diff);
    const focus = document.getElementById('playerFocus').value;
    document.getElementById('rankingTable').innerHTML = stats.map((s,i) => `
        <tr class="${i === 0 && s.points > 0 ? 'rank-gold' : ''} border-b border-[var(--border)] last:border-none ${s.name === focus ? '!bg-blue-500/10' : ''}">
            <td class="py-5 pl-6 pr-2 font-900 text-sm">${i === 0 && s.points > 0 ? 'üëë' : '#' + (i + 1)}</td>
            <td class="py-5 px-2 text-[14px] font-900 uppercase truncate ${s.name === focus ? 'text-focus' : ''}">${s.name}</td>
            <td class="py-5 px-2 text-center text-[12px] font-700 text-[var(--text-muted)]">${s.wins}/${s.losses}</td>
            <td class="py-5 px-2 text-center font-900 text-base" style="font-family:'Space Mono'">${s.points}</td>
            <td class="py-5 pl-2 pr-6 text-center text-[12px] font-900 ${s.diff > 0 ? 'text-[var(--green)]' : s.diff < 0 ? 'text-[var(--red)]' : ''}">${s.diff > 0 ? '+' : ''}${s.diff}</td>
        </tr>`).join('');
}

init();
</script>
</body>
</html>
