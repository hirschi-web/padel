<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Turnier - Live Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .score-input:disabled { background: transparent; border: none; color: #1e293b; font-weight: 800; -webkit-appearance: none; opacity: 1; }
        .score-input { width: 40px; text-align: center; border-radius: 8px; font-weight: 800; padding: 4px; background: #f8fafc; border: 1px solid #e2e8f0; }
        .is-editing .score-input:not(:disabled) { background: #fff; border: 2px solid #3b82f6; box-shadow: 0 0 10px rgba(59,130,246,0.2); }
        .rank-1 { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 1px solid #f59e0b; }
        .bot-gradient { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans pb-20">

    <div class="max-w-md mx-auto p-4">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 id="tournamentTitle" class="text-3xl font-black italic uppercase tracking-tighter text-blue-600 leading-none">LADE...</h1>
                <p id="tournamentSub" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Live Scoreboard & Analytics</p>
            </div>
            <div class="flex gap-2">
                <button onclick="location.reload()" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 hover:bg-slate-50">üîÑ</button>
                <button id="lockBtn" onclick="toggleEditMode()" class="bg-white p-3 rounded-2xl shadow-sm border border-slate-200 hover:bg-slate-50 text-xl">üîí</button>
            </div>
        </div>

        <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 mb-6">
            <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Spieler Fokus</label>
            <select id="playerFocus" onchange="renderAll()" class="w-full p-3 bg-slate-50 border-none rounded-2xl font-bold outline-none ring-2 ring-slate-100 focus:ring-blue-500 transition-all">
                <option value="">-- Wer bist du? --</option>
            </select>
        </div>

        <div id="scheduleArea" class="space-y-6"></div>

        <div class="mt-12 pt-10 border-t border-slate-200">
            <h2 class="text-2xl font-black italic uppercase text-slate-800 mb-6 flex items-center gap-3">
                üèÜ <span id="rankingTypeTitle">Live Ranking</span>
            </h2>
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-900 text-white text-[10px] uppercase tracking-widest">
                            <th class="p-4">Pos</th>
                            <th class="p-4" id="rankNameHeader">Spieler</th>
                            <th class="p-4 text-center">Pkt</th>
                            <th class="p-4 text-center">Diff</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTable"></tbody>
                </table>
            </div>
        </div>

        <div class="mt-10 bot-gradient p-6 rounded-[2.5rem] shadow-2xl text-white relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex items-center gap-2 mb-4">
                    <span class="bg-blue-500 text-[10px] font-black px-2 py-1 rounded-md uppercase">Beta</span>
                    <h3 class="text-lg font-black italic uppercase tracking-tight">Padel-Bot Analyse</h3>
                </div>
                <p id="botText" class="text-blue-100 text-sm leading-relaxed font-medium">Berechne aktuelle Trends...</p>
                <div class="mt-6 pt-6 border-t border-white/10 flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-xl">ü§ñ</div>
                    <div>
                        <p class="text-[10px] font-black uppercase text-blue-400 tracking-widest">Status</p>
                        <p class="text-xs font-bold" id="botStatus">Analysiere Spielverlauf</p>
                    </div>
                </div>
            </div>
            <div class="absolute -right-10 -bottom-10 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl"></div>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        let tournamentId = decodeURIComponent(window.location.search.substring(1)).replace(/\/$/, "");
        let tournamentData = null;
        let isEditing = false;

        async function init() {
            if(!tournamentId) {
                document.getElementById('tournamentTitle').innerText = "KEIN TURNIER";
                return;
            }

            const { data, error } = await supabaseClient.from('tournaments').select('*').eq('id', tournamentId);

            if (error || !data || data.length === 0) {
                document.getElementById('tournamentTitle').innerText = "FEHLER";
                return;
            }

            tournamentData = data[0].data;
            document.getElementById('tournamentTitle').innerText = data[0].id.toUpperCase();
            
            if(tournamentData.type === 'team') {
                document.getElementById('rankingTypeTitle').innerText = "Team Ranking";
                document.getElementById('rankNameHeader').innerText = "Team";
            }

            const focusSelect = document.getElementById('playerFocus');
            tournamentData.p.forEach(name => focusSelect.add(new Option(name, name)));
            
            renderAll();
        }

        function toggleEditMode() {
            if(!isEditing) {
                const pw = prompt("Admin-Passwort eingeben:");
                if(pw === tournamentData.pw) {
                    isEditing = true;
                    document.getElementById('lockBtn').innerText = "üîì";
                    document.body.classList.add('is-editing');
                    renderAll();
                } else { alert("Falsches Passwort!"); }
            } else {
                isEditing = false;
                document.getElementById('lockBtn').innerText = "üîí";
                document.body.classList.remove('is-editing');
                renderAll();
            }
        }

        async function saveScore(roundIdx, matchIdx, teamIdx, val) {
            tournamentData.s_new[roundIdx].matches[matchIdx].score[teamIdx] = val;
            await supabaseClient.from('tournaments').update({ data: tournamentData }).eq('id', tournamentId);
            updateRanking();
        }

        function renderAll() {
            const focus = document.getElementById('playerFocus').value;
            const area = document.getElementById('scheduleArea');
            area.innerHTML = '';

            tournamentData.s_new.forEach((round, rIdx) => {
                let html = `<div class="mb-10">
                    <h3 class="text-[10px] font-black text-blue-600 uppercase tracking-[0.3em] mb-4 flex items-center gap-2">
                        <span class="w-8 h-[2px] bg-blue-600"></span> Runde ${round.id} ‚Ä¢ ${round.time}
                    </h3>
                    <div class="space-y-3">`;

                round.matches.forEach((m, mIdx) => {
                    const names = [...m.team1, ...m.team2].map(i => tournamentData.p[i]);
                    const isFocus = focus && names.includes(focus);
                    
                    html += `
                    <div class="bg-white p-4 rounded-[2rem] shadow-sm border-2 ${isFocus ? 'border-blue-500 shadow-blue-100 shadow-lg' : 'border-slate-100'} transition-all">
                        <div class="grid grid-cols-7 items-center gap-1">
                            <div class="col-span-3 space-y-1">
                                <div class="text-[11px] font-black truncate ${focus === tournamentData.p[m.team1[0]] ? 'text-blue-600' : 'text-slate-700'}">${tournamentData.p[m.team1[0]]}</div>
                                <div class="text-[11px] font-black truncate ${focus === tournamentData.p[m.team1[1]] ? 'text-blue-600' : 'text-slate-700'}">${tournamentData.p[m.team1[1]]}</div>
                            </div>
                            <div class="col-span-1 flex flex-col items-center gap-1">
                                <input type="number" value="${m.score[0]}" ${!isEditing ? 'disabled' : ''} onchange="saveScore(${rIdx}, ${mIdx}, 0, this.value)" class="score-input">
                                <div class="text-[8px] font-black text-slate-300 italic">VS</div>
                                <input type="number" value="${m.score[1]}" ${!isEditing ? 'disabled' : ''} onchange="saveScore(${rIdx}, ${mIdx}, 1, this.value)" class="score-input">
                            </div>
                            <div class="col-span-3 space-y-1 text-right">
                                <div class="text-[11px] font-black truncate ${focus === tournamentData.p[m.team2[0]] ? 'text-blue-600' : 'text-slate-700'}">${tournamentData.p[m.team2[0]]}</div>
                                <div class="text-[11px] font-black truncate ${focus === tournamentData.p[m.team2[1]] ? 'text-blue-600' : 'text-slate-700'}">${tournamentData.p[m.team2[1]]}</div>
                            </div>
                        </div>
                    </div>`;
                });

                if(round.pause && round.pause.length > 0) {
                    html += `<p class="text-[9px] font-bold text-slate-400 mt-3 px-4 italic">Pause: ${round.pause.map(i => tournamentData.p[i]).join(', ')}</p>`;
                }
                html += `</div></div>`;
                area.innerHTML += html;
            });
            updateRanking();
        }

        function updateRanking() {
            const isTeamMode = tournamentData.type === 'team';
            let stats = [];

            if(isTeamMode) {
                // Team Ranking: Wir fassen immer 2 Spieler zu einer ID zusammen
                for(let i=0; i < tournamentData.p.length; i+=2) {
                    stats.push({ 
                        name: `${tournamentData.p[i]} / ${tournamentData.p[i+1]}`, 
                        ids: [i, i+1], points: 0, diff: 0, games: 0 
                    });
                }
            } else {
                // Solo Ranking
                stats = tournamentData.p.map((name, i) => ({ name, ids: [i], points: 0, diff: 0, games: 0 }));
            }

            tournamentData.s_new.forEach(r => {
                r.matches.forEach(m => {
                    if(m.score[0] !== "" && m.score[1] !== "" && m.score[0] !== null) {
                        const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
                        stats.forEach(entry => {
                            // Pr√ºfe ob einer der Spieler des Ranking-Eintrags im Team1 oder Team2 war
                            if(entry.ids.some(id => m.team1.includes(id))) {
                                entry.points += s1; entry.diff += (s1 - s2); entry.games++;
                            }
                            if(entry.ids.some(id => m.team2.includes(id))) {
                                entry.points += s2; entry.diff += (s2 - s1); entry.games++;
                            }
                        });
                    }
                });
            });

            stats.sort((a,b) => b.points - a.points || b.diff - a.diff);
            
            document.getElementById('rankingTable').innerHTML = stats.map((s, i) => `
                <tr class="${i === 0 ? 'rank-1' : ''} border-b border-slate-50 last:border-none">
                    <td class="p-4 font-black text-xs text-slate-400">#${i+1}</td>
                    <td class="p-4 font-bold text-xs">${s.name}</td>
                    <td class="p-4 text-center font-black">${s.points}</td>
                    <td class="p-4 text-center font-bold text-xs ${s.diff > 0 ? 'text-green-600' : s.diff < 0 ? 'text-red-600' : ''}">${s.diff > 0 ? '+' : ''}${s.diff}</td>
                </tr>
            `).join('');

            updateAI(stats);
        }

        function updateAI(stats) {
            const top = stats[0];
            const botText = document.getElementById('botText');
            if(top && top.games > 0) {
                const trend = top.diff > 5 ? "dominiert das Feld mit einer starken Defensive." : "f√ºhrt das Feld in einem engen Kopf-an-Kopf Rennen an.";
                botText.innerText = `${top.name} ${trend} Die aktuelle Prognose sieht eine Gewinnchance von ${60 + Math.min(top.diff, 30)}% f√ºr den Turniersieg.`;
                document.getElementById('botStatus').innerText = "Berechnung abgeschlossen";
            } else {
                botText.innerText = "Sammle erste Spielergebnisse f√ºr eine pr√§zise Prognose...";
                document.getElementById('botStatus').innerText = "Warte auf Daten";
            }
        }

        init();
    </script>
</body>
</html>
