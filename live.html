<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Scoreboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .winner { color: #16a34a !important; font-weight: 900 !important; }
        .score-box { width: 35px; text-align: center; font-weight: bold; backgroundke: #f1f5f9; border-radius: 4px; color: #2563eb; padding: 4px 0; }
        .leader-row { background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="bg-slate-50 p-3 max-w-5xl mx-auto text-slate-900">
    <div id="loader" class="text-center p-20 text-slate-400 font-bold italic animate-pulse">ðŸ“¡ Verbinde mit Live-Daten...</div>
    
    <div id="content" class="hidden">
        <div class="mb-4 p-4 bg-blue-600 text-white rounded-xl shadow-lg flex justify-between items-center">
            <h1 class="font-black italic uppercase tracking-tighter">Live Padel Ranking</h1>
            <div id="lastUpdate" class="text-[9px] opacity-70 font-mono"></div>
        </div>
        
        <div class="mb-6 bg-slate-900 text-white p-4 rounded-xl shadow-lg border-b-4 border-blue-500">
            <label class="block text-[10px] uppercase font-bold mb-2 text-slate-400 italic">Meine nÃ¤chsten Termine:</label>
            <select id="userSelect" onchange="renderLive()" class="w-full bg-slate-800 border-none p-2 rounded font-bold outline-none text-blue-400"></select>
            <div id="userNext" class="mt-3 grid grid-cols-1 gap-1 text-sm"></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-4">
                <h2 class="font-black text-slate-400 uppercase text-[10px] tracking-widest">Spielplan & Ergebnisse</h2>
                <div id="schedule" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div class="space-y-4">
                <h2 class="font-black text-slate-400 uppercase text-[10px] tracking-widest">Tabelle</h2>
                <div class="bg-slate-900 rounded-2xl shadow-xl overflow-hidden">
                    <table class="w-full text-sm">
                        <tbody id="rankingBody" class="text-white divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // HIER DEINE DATEN EINTRAGEN
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.com";
        const SB_KEY = "sb_publishable_23hd0DzvVtl1tUS9lqIlNg_if0C1qzG";
        const T_ID = "padel_01";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        
        let currentData = null;

        async function fetchLive() {
            try {
                const { data, error } = await supabaseClient.from('tournaments').select('data').eq('id', T_ID).single();
                if (data) {
                    currentData = data.data;
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                    document.getElementById('lastUpdate').innerText = new Date().toLocaleTimeString();
                    renderLive();
                }
            } catch (e) { console.error("Fetch error", e); }
        }

        function renderLive() {
            const { p, s, m, t } = currentData;
            const sel = document.getElementById('userSelect').value;

            // Spieler-Auswahl initialisieren
            if(!document.getElementById('userSelect').innerHTML) {
                document.getElementById('userSelect').innerHTML = '<option value="">WÃ¤hle deinen Namen...</option>' + p.map(x => `<option value="${x}">${x}</option>`).join('');
            }

            // Zeitberechnung
            const getT = (i) => {
                let [h, min] = t.start.split(':').map(Number);
                let tot = h * 60 + min + t.warmup + (i * t.match);
                return `${String(Math.floor(tot/60)%24).padStart(2,'0')}:${String(tot%60).padStart(2,'0')}`;
            };

            // Spielplan rendern
            document.getElementById('schedule').innerHTML = s.map((r, i) => `
                <div class="p-3 bg-white rounded-xl border border-slate-200 shadow-sm relative overflow-hidden">
                    <div class="flex justify-between text-[9px] font-bold text-slate-400 mb-2 uppercase">
                        <span>R${r.id} | ${getT(i)} Uhr</span>
                        <span class="${sel && r.pause.some(idx => p[idx] === sel) ? 'bg-orange-500 text-white' : 'text-orange-500 bg-orange-50'} px-2 py-0.5 rounded">Pause: ${p[r.pause[0]]}, ${p[r.pause[1]]}</span>
                    </div>
                    ${renderC(r, 's2', 'c2', 'C2', p, sel)}
                    <div class="h-[1px] bg-slate-50 my-2"></div>
                    ${renderC(r, 's3', 'c3', 'C3', p, sel)}
                </div>`).join('');

            // Vorschau-Logik
            if (sel) {
                let upcoming = [];
                s.forEach((r, i) => {
                    const time = getT(i);
                    if (r.pause.some(idx => p[idx] === sel)) upcoming.push(`Runde ${r.id} (${time}): â¸ï¸ Du hast Pause`);
                    else if (r.c2.some(idx => p[idx] === sel)) upcoming.push(`Runde ${r.id} (${time}): ðŸŽ¾ Court 2`);
                    else if (r.c3.some(idx => p[idx] === sel)) upcoming.push(`Runde ${r.id} (${time}): ðŸŽ¾ Court 3`);
                });
                document.getElementById('userNext').innerHTML = upcoming.slice(0, 2).map(txt => `<div class="bg-blue-600/20 p-2 rounded border border-blue-500/30">${txt}</div>`).join('');
            } else {
                document.getElementById('userNext').innerHTML = "";
            }

            // Ranking Logik
            let st = p.map(name => ({ name, points: 0, m: 0 }));
            s.forEach(r => {
                const add = (pI, sV, oV) => { if(sV!=="" && oV!=="") { let sv=parseInt(sV), ov=parseInt(oV); pI.forEach(x => { st[x].points += (m==='diff'?sv-ov:sv); st[x].m++; }); } };
                add([r.c2[0], r.c2[1]], r.s2[0], r.s2[1]); add([r.c2[2], r.c2[3]], r.s2[1], r.s2[0]);
                add([r.c3[0], r.c3[1]], r.s3[0], r.s3[1]); add([r.c3[2], r.c3[3]], r.s3[1], r.s3[0]);
            });
            st.sort((a,b) => b.points - a.points);
            document.getElementById('rankingBody').innerHTML = st.map((s, i) => `
                <tr class="${s.points>0 && s.points===st[0].points ? 'leader-row' : ''}">
                    <td class="p-3 text-slate-500 font-mono text-[10px]">${i+1}</td>
                    <td class="p-3 font-bold">${s.name}</td>
                    <td class="p-3 text-right font-black text-blue-400 text-base">${s.points}</td>
                </tr>`).join('');
        }

        function renderC(r, sK, cK, lbl, p, sel) {
            const s1 = r[sK][0]===""?-1:parseInt(r[sK][0]), s2 = r[sK][1]===""?-1:parseInt(r[sK][1]), isD = s1!==-1 && s2!==-1;
            const isMy = sel && r[cK].some(i => p[i] === sel);
            return `<div class="flex items-center gap-2 ${isMy ? 'bg-blue-50 ring-1 ring-blue-100 rounded-lg p-1' : ''}">
                <div class="w-5 text-[9px] font-black text-slate-200">${lbl}</div>
                <div class="flex-1 text-right text-[11px] leading-tight ${isD && s1>s2?'winner':''}">${p[r[cK][0]]}<br>${p[r[cK][1]]}</div>
                <div class="score-box">${r[sK][0] !== "" ? r[sK][0] : '-'}</div>
                <div class="score-box">${r[sK][1] !== "" ? r[sK][1] : '-'}</div>
                <div class="flex-1 text-left text-[11px] leading-tight ${isD && s2>s1?'winner':''}">${p[r[cK][2]]}<br>${p[r[cK][3]]}</div>
            </div>`;
        }

        // Automatisch alle 15 Sekunden prÃ¼fen
        setInterval(fetchLive, 15000); 
        fetchLive();
    </script>
</body>
</html>
