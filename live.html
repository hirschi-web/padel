<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padel Hirsch ‚Äì Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #2563eb; --blue-dark: #1e40af; --slate: #0f172a; --muted: #64748b; --bg: #f8fafc; }
        body { font-family: Arial, sans-serif; background: var(--bg); color: var(--slate); -webkit-tap-highlight-color: transparent; }
        .display { font-family: 'Barlow Condensed', sans-serif; }
        .card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .score-input { width: 44px; height: 44px; text-align: center; font-size: 20px; font-weight: 800; border-radius: 10px; border: 2px solid #e2e8f0; background: #f1f5f9; outline: none; transition: all 0.2s; }
        .score-input:focus { border-color: var(--blue); background: white; box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
        .match-row { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 12px 0; }
        .team-box { display: flex; flex-direction: column; gap: 2px; }
        .player-name { font-size: 13px; font-weight: 600; line-height: 1.2; }
        .vs-pill { font-family: 'Barlow Condensed', sans-serif; font-size: 10px; font-weight: 900; color: var(--muted); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .focus-ring { border: 2px solid var(--blue) !important; background: #eff6ff !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .live-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse 1.5s infinite; }
    </style>
</head>
<body class="p-4 pb-24">

<div class="max-w-md mx-auto">
    <div class="flex items-center justify-between mb-6">
        <div>
            <p class="text-[10px] font-bold text-blue-600 uppercase tracking-widest mb-1">Padel Hirsch</p>
            <h1 id="tournamentTitle" class="display text-3xl font-900 italic uppercase leading-none text-slate-900">Lade...</h1>
        </div>
        <div class="flex gap-2">
            <button onclick="loadTournament()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 shadow-sm active:scale-95 transition-transform">üîÑ</button>
            <button onclick="toggleAdmin()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white border border-slate-200 shadow-sm active:scale-95 transition-transform">üîí</button>
        </div>
    </div>

    <div class="flex gap-2 mb-6">
        <button onclick="switchTab('games')" id="tabGames" class="flex-1 py-3 rounded-xl font-bold text-xs uppercase tracking-wider bg-slate-900 text-white shadow-lg transition-all">Live Scoreboard</button>
    </div>

    <div id="viewGames" class="space-y-6">
        <div id="errorView" class="hidden text-center py-12">
            <span class="text-4xl mb-4 block">ü¶å</span>
            <h2 class="display text-2xl font-bold text-slate-800">Turnier nicht gefunden</h2>
            <p class="text-sm text-muted">Pr√ºfe den Link oder erstelle ein neues Turnier.</p>
        </div>

        <div id="contentView" class="hidden space-y-6">
            <div class="card p-4">
                <label class="block text-[10px] font-bold text-muted uppercase tracking-wider mb-2">Dein Fokus</label>
                <select id="focusPlayer" onchange="updateView()" class="w-full p-3 rounded-xl bg-slate-50 border-none font-bold text-sm outline-none ring-1 ring-slate-200 focus:ring-blue-500 transition-all">
                    <option value="">‚Äì W√§hle deinen Namen / Team ‚Äì</option>
                </select>
            </div>

            <div id="roundList" class="space-y-4"></div>

            <div class="card p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="display text-xl font-bold italic uppercase tracking-tight">üèÜ Ranking</h3>
                </div>
                <div class="overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead>
                            <tr class="text-muted border-bottom border-slate-100 uppercase font-bold tracking-tighter">
                                <th class="pb-2 w-8">#</th>
                                <th class="pb-2">Teilnehmer</th>
                                <th class="pb-2 text-center">W/L</th>
                                <th class="pb-2 text-center">Pkt</th>
                                <th class="pb-2 text-right">Diff</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody" class="font-medium"></tbody>
                    </table>
                </div>
            </div>

            <div class="card bg-slate-900 text-white p-5 overflow-hidden relative">
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="live-dot"></span>
                        <p class="text-[10px] font-black uppercase tracking-widest text-blue-400">Hirsch KI ¬∑ Analyse</p>
                    </div>
                    <p id="aiInsight" class="text-sm leading-relaxed font-medium text-slate-200 italic">W√§hle oben deinen Fokus f√ºr eine pers√∂nliche Analyse...</p>
                </div>
                <div class="absolute -right-4 -bottom-4 opacity-10 rotate-12">
                    <svg width="120" height="120" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 left-4 right-4 flex justify-center pointer-events-none">
        <div class="bg-white/90 backdrop-blur border border-slate-200 px-4 py-2 rounded-full shadow-2xl pointer-events-auto flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div id="statusDot" class="w-2 h-2 rounded-full bg-green-500"></div>
                <span id="statusText" class="text-[10px] font-bold uppercase tracking-widest text-slate-600">Standby</span>
            </div>
        </div>
    </div>
</div>

<div id="adminOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
    <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
        <h3 class="display text-2xl font-bold mb-4">Admin-Bereich</h3>
        <p class="text-xs text-muted mb-4 font-medium">Gib das Passwort ein, um Ergebnisse einzutragen oder zu √§ndern.</p>
        <input type="password" id="adminPwInput" class="w-full p-4 bg-slate-100 rounded-2xl mb-4 border-none outline-none focus:ring-2 focus:ring-blue-500 transition-all font-bold" placeholder="Passwort">
        <div class="grid grid-cols-2 gap-3">
            <button onclick="toggleAdmin()" class="py-3 font-bold text-xs uppercase bg-slate-100 rounded-xl">Abbrechen</button>
            <button onclick="verifyAdmin()" class="py-3 font-bold text-xs uppercase bg-blue-600 text-white rounded-xl">Login</button>
        </div>
    </div>
</div>

<div id="saveToast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-green-600 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-[100] translate-y-[-100px] transition-transform duration-500 flex items-center gap-2">
    <span>‚úì</span> Speichern...
</div>
<div id="doneToast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-[100] translate-y-[-100px] transition-transform duration-500 flex items-center gap-2">
    <span>‚úì</span> Gespeichert
</div>

<script>
const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

let tournamentData = null, tid = "", isAdmin = false, players = [], schedule = [];

async function loadTournament() {
    tid = new URLSearchParams(window.location.search).get('t') || window.location.search.substring(1);
    if(!tid) { showPageError(); return; }

    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    statusDot.className = "w-2 h-2 rounded-full bg-amber-500";
    statusText.innerText = "L√ÑDT...";

    try {
        const { data, error } = await supabaseClient.from('tournaments').select('data').eq('id', tid).single();
        if(error || !data) throw error;
        
        // WICHTIG: Die Daten liegen im Feld 'data'
        tournamentData = data.data;
        players = tournamentData.p || [];
        schedule = tournamentData.s_new || [];
        
        document.getElementById('tournamentTitle').innerText = tid;
        document.getElementById('contentView').classList.remove('hidden');
        document.getElementById('errorView').classList.add('hidden');
        
        populateFocus();
        updateView();
        
        statusDot.className = "w-2 h-2 rounded-full bg-green-500";
        statusText.innerText = "LIVE";
    } catch(e) {
        console.error(e);
        showPageError();
    }
}

function showPageError() {
    document.getElementById('errorView').classList.remove('hidden');
    document.getElementById('contentView').classList.add('hidden');
    document.getElementById('tournamentTitle').innerText = "Fehler";
}

function populateFocus() {
    const sel = document.getElementById('focusPlayer');
    const current = sel.value;
    sel.innerHTML = '<option value="">‚Äì W√§hle deinen Namen / Team ‚Äì</option>';
    players.forEach((p, i) => {
        const opt = document.createElement('option');
        opt.value = i; opt.innerText = p;
        sel.appendChild(opt);
    });
    sel.value = current;
}

function toggleAdmin() {
    const overlay = document.getElementById('adminOverlay');
    overlay.classList.toggle('hidden');
    if(!overlay.classList.contains('hidden')) document.getElementById('adminPwInput').focus();
}

function verifyAdmin() {
    const pw = document.getElementById('adminPwInput').value;
    if(pw === (tournamentData.pw || "1234")) {
        isAdmin = true;
        toggleAdmin();
        updateView();
        showToast("doneToast");
    } else {
        alert("Falsches Passwort");
    }
}

function updateView() {
    renderRounds();
    renderRanking();
    updateAIInsight();
}

function renderRounds() {
    const container = document.getElementById('roundList');
    const focusIdx = document.getElementById('focusPlayer').value;
    container.innerHTML = "";

    schedule.forEach((round, rIdx) => {
        const roundCard = document.createElement('div');
        roundCard.className = "card p-5";
        
        let roundHtml = `<div class="flex items-center justify-between mb-4">
            <h3 class="display text-xl font-bold italic uppercase tracking-tight">Runde ${round.id}</h3>
            <span class="text-[10px] font-black text-muted tracking-widest">${round.time} UHR</span>
        </div><div class="divide-y divide-slate-100">`;

        round.matches.forEach((m, mIdx) => {
            const isFocus = focusIdx !== "" && (m.team1.includes(parseInt(focusIdx)) || m.team2.includes(parseInt(focusIdx)));
            
            roundHtml += `
                <div class="match-row ${isFocus ? 'bg-blue-50/50 -mx-5 px-5' : ''}">
                    <div class="team-box text-right">
                        <span class="player-name ${focusIdx != "" && m.team1.includes(parseInt(focusIdx)) ? 'text-blue-600 font-bold' : ''}">${players[m.team1[0]]}</span>
                        <span class="player-name ${focusIdx != "" && m.team1.includes(parseInt(focusIdx)) ? 'text-blue-600 font-bold' : ''}">${players[m.team1[1]]}</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <div class="flex items-center gap-1">
                            <input type="number" value="${m.score[0]}" ${!isAdmin ? 'readonly' : ''} 
                                onchange="saveScore(${rIdx}, ${mIdx}, 0, this.value)"
                                class="score-input ${isFocus ? 'border-blue-200' : ''}">
                            <span class="vs-pill">VS</span>
                            <input type="number" value="${m.score[1]}" ${!isAdmin ? 'readonly' : ''} 
                                onchange="saveScore(${rIdx}, ${mIdx}, 1, this.value)"
                                class="score-input ${isFocus ? 'border-blue-200' : ''}">
                        </div>
                        <span class="text-[8px] font-bold text-muted uppercase">Platz ${m.court}</span>
                    </div>
                    <div class="team-box text-left">
                        <span class="player-name ${focusIdx != "" && m.team2.includes(parseInt(focusIdx)) ? 'text-blue-600 font-bold' : ''}">${players[m.team2[0]]}</span>
                        <span class="player-name ${focusIdx != "" && m.team2.includes(parseInt(focusIdx)) ? 'text-blue-600 font-bold' : ''}">${players[m.team2[1]]}</span>
                    </div>
                </div>`;
        });

        roundHtml += `</div>`;
        if(round.pause && round.pause.length > 0) {
            const pauseNames = round.pause.map(pIdx => players[pIdx]).join(", ");
            roundHtml += `<div class="mt-3 pt-3 border-t border-dashed border-slate-200 text-center">
                <span class="text-[9px] font-bold text-muted uppercase tracking-wider">Pause: ${pauseNames}</span>
            </div>`;
        }
        
        roundCard.innerHTML = roundHtml;
        container.appendChild(roundCard);
    });
}

async function saveScore(rIdx, mIdx, tIdx, val) {
    schedule[rIdx].matches[mIdx].score[tIdx] = val;
    showToast("saveToast");
    
    const { error } = await supabaseClient.from('tournaments').update({ 
        data: { ...tournamentData, s_new: schedule } 
    }).eq('id', tid);
    
    if(!error) {
        setTimeout(() => {
            showToast("doneToast");
            renderRanking();
            updateAIInsight();
        }, 500);
    }
}

function renderRanking() {
    let stats = players.map((name, index) => ({ name, wins: 0, losses: 0, points: 0, diff: 0 }));

    schedule.forEach(round => {
        round.matches.forEach(m => {
            const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
            if(!isNaN(s1) && !isNaN(s2)) {
                const team1 = m.team1, team2 = m.team2;
                team1.forEach(p => { stats[p].points += s1; stats[p].diff += (s1 - s2); });
                team2.forEach(p => { stats[p].points += s2; stats[p].diff += (s2 - s1); });
                if(s1 > s2) { team1.forEach(p => stats[p].wins++); team2.forEach(p => stats[p].losses++); }
                else if(s2 > s1) { team2.forEach(p => stats[p].wins++); team1.forEach(p => stats[p].losses++); }
            }
        });
    });

    stats.sort((a, b) => b.wins - a.wins || b.diff - a.diff || b.points - a.points);
    
    const body = document.getElementById('rankingBody');
    body.innerHTML = stats.map((s, i) => `
        <tr class="border-b border-slate-50 last:border-0">
            <td class="py-3 font-bold text-muted">${i+1}</td>
            <td class="py-3 font-bold text-slate-900">${s.name}</td>
            <td class="py-3 text-center">${s.wins}/${s.losses}</td>
            <td class="py-3 text-center font-bold text-blue-600">${s.points}</td>
            <td class="py-3 text-right font-mono text-[10px]">${s.diff > 0 ? '+' : ''}${s.diff}</td>
        </tr>
    `).join('');
}

function updateAIInsight() {
    const focusIdx = document.getElementById('focusPlayer').value;
    const aiText = document.getElementById('aiInsight');
    if(focusIdx === "") { aiText.innerText = "W√§hle oben deinen Fokus f√ºr eine pers√∂nliche Analyse..."; return; }
    
    // Einfache KI-Logik
    aiText.innerText = "Analysiere deine Performance... Dein Hirsch-Instinkt sagt: Konzentriere dich auf konstante Returns!";
}

function showToast(id) {
    const t = document.getElementById(id);
    t.style.transform = "translate(-50%, 40px)";
    setTimeout(() => { t.style.transform = "translate(-50%, -100px)"; }, 2000);
}

function switchTab(tab) { /* Nur ein Tab vorhanden aktuell */ }

init();
async function init() {
    await loadTournament();
    // Auto-Refresh alle 30 Sekunden
    setInterval(loadTournament, 30000);
}
</script>
</body>
</html>
