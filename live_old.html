<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Padel Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans leading-tight">
    <div id="loader" class="flex flex-col items-center justify-center h-screen text-slate-400 animate-pulse">
        <p class="font-bold italic">Suche Live-Turnier...</p>
    </div>
    
    <div id="content" class="hidden">
        <div class="sticky top-0 z-50 bg-blue-600 text-white p-4 shadow-md flex justify-between items-center">
            <div>
                <h1 id="tournamentTitle" class="font-black italic uppercase text-lg leading-none">Padel Live</h1>
                <div id="lastUpdate" class="text-[9px] opacity-80 mt-1 font-mono"></div>
            </div>
            <button onclick="fetchLive()" class="bg-blue-500 p-2 rounded-full active:scale-90 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
        
        <div class="m-3 bg-slate-900 text-white p-4 rounded-2xl shadow-lg border-b-4 border-blue-500">
            <select id="userSelect" onchange="localStorage.setItem('padel_username', this.value); renderLive();" class="w-full bg-slate-800 border-none p-3 rounded-xl font-bold text-white text-base mb-3 appearance-none shadow-inner">
                <option value="">Wer bist du?</option>
            </select>
            <div id="userNext" class="space-y-2"></div>
        </div>

        <div class="px-3 space-y-6">
            <div class="bg-slate-900 rounded-2xl shadow-xl overflow-hidden p-3 border-b-4 border-blue-600">
                <table class="w-full text-sm"><tbody id="rankingBody" class="text-white divide-y divide-slate-800"></tbody></table>
            </div>
            <div id="schedule" class="space-y-3"></div>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        let currentData = null;

        async function fetchLive() {
            try {
                const { data: config } = await supabaseClient.from('tournaments').select('data').eq('id', 'LIVE_CONFIG').single();
                if(!config) return;
                const activeID = config.data.active_id;
                document.getElementById('tournamentTitle').innerText = activeID;
                const { data } = await supabaseClient.from('tournaments').select('data').eq('id', activeID).single();
                if (data) {
                    currentData = data.data;
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('content').classList.remove('hidden');
                    document.getElementById('lastUpdate').innerText = "Stand: " + new Date().toLocaleTimeString();
                    renderLive();
                }
            } catch (e) { console.error(e); }
        }

        function renderLive() {
            const { p, s_new, m, t } = currentData;
            const sel = localStorage.getItem('padel_username') || "";
            if(document.getElementById('userSelect').options.length <= 1) {
                document.getElementById('userSelect').innerHTML = '<option value="">Wer bist du?</option>' + p.map(x => `<option value="${x}">${x}</option>`).join('');
                document.getElementById('userSelect').value = sel;
            }
            document.getElementById('schedule').innerHTML = s_new.map((r) => `
                <div class="p-4 bg-white rounded-2xl border border-slate-200 shadow-sm relative">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 mb-3 uppercase tracking-tight">
                        <span>RUNDE ${r.id} ${r.time ? ' • ' + r.time + ' Uhr' : ''}</span>
                    </div>
                    ${r.matches.map(m => {
                        const isMy = sel && m.team1.concat(m.team2).includes(p.indexOf(sel));
                        return `
                        <div class="flex items-center gap-2 p-2 mb-1 rounded-xl ${isMy ? 'bg-blue-50 border border-blue-100' : ''}">
                            <div class="w-5 text-[8px] font-black text-slate-300 italic">C${m.court}</div>
                            <div class="flex-1 text-right text-[11px] leading-tight font-bold">${p[m.team1[0]]}<br>${p[m.team1[1]]}</div>
                            <div class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded font-black text-blue-600 border">${m.score[0] || '·'}</div>
                            <div class="w-8 h-8 flex items-center justify-center bg-slate-50 rounded font-black text-blue-600 border">${m.score[1] || '·'}</div>
                            <div class="flex-1 text-left text-[11px] leading-tight font-bold">${p[m.team2[0]]}<br>${p[m.team2[1]]}</div>
                        </div>`;
                    }).join('')}
                    <div class="text-[9px] font-black text-orange-500 uppercase mt-2 italic">Pause: ${r.pause.map(idx => p[idx]).join(', ') || 'Keiner'}</div>
                </div>`).join('');

            // Vorschau
            if(sel) {
                const myIdx = p.indexOf(sel);
                const next = s_new.find(r => r.matches.some(m => m.team1.concat(m.team2).includes(myIdx)) && r.matches.find(m => m.team1.concat(m.team2).includes(myIdx)).score[0] === "");
                if(next) {
                    const m = next.matches.find(m => m.team1.concat(m.team2).includes(myIdx));
                    document.getElementById('userNext').innerHTML = `<div class="bg-blue-600/20 p-3 rounded-xl border border-blue-500/30 text-[10px] font-black text-blue-300 uppercase italic">Nächstes Spiel: Runde ${next.id} | Court ${m.court}</div>`;
                }
            }

            // Ranking
            let st = p.map(name => ({ name, pts: 0 }));
            s_new.forEach(r => r.matches.forEach(m => {
                if(m.score[0] !== "" && m.score[1] !== "") {
                    const s1 = parseInt(m.score[0]), s2 = parseInt(m.score[1]);
                    m.team1.forEach(idx => st[idx].pts += (m==='diff'?s1-s2:s1));
                    m.team2.forEach(idx => st[idx].pts += (m==='diff'?s2-s1:s2));
                }
            }));
            st.sort((a,b) => b.pts - a.pts);
            document.getElementById('rankingBody').innerHTML = st.map((s, i) => `
                <tr class="${s.name === sel ? 'bg-blue-500/20' : ''}">
                    <td class="p-3 text-slate-500 font-mono text-xs w-8">${i+1}</td>
                    <td class="p-3 font-bold text-sm">${s.name}</td>
                    <td class="p-3 text-right font-black text-blue-400 text-lg">${s.pts}</td>
                </tr>`).join('');
        }

        setInterval(fetchLive, 10000);
        fetchLive();
    </script>
</body>
</html>
