<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>K.O. Turnier Live</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
--bg:#0f172a;--bg-card:#1e293b;--bg-hover:#334155;
--text:#f1f5f9;--text-muted:#94a3b8;
--blue:#3b82f6;--green:#4ade80;--red:#f87171;--amber:#fbbf24;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:1rem}
.container{max-width:600px;margin:0 auto}
.header{background:var(--bg-card);border-radius:16px;padding:1rem;margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.5rem}
.title{font-size:1.5rem;font-weight:800;color:var(--blue)}
.subtitle{font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem}
.btn{padding:0.5rem 1rem;border-radius:8px;border:none;font-weight:600;font-size:0.875rem;cursor:pointer;transition:all .2s}
.btn-primary{background:var(--blue);color:white}
.btn-primary:hover{opacity:0.9}
.btn-secondary{background:var(--bg-hover);color:var(--text)}
.btn-sm{padding:0.375rem 0.75rem;font-size:0.75rem}
.tabs{display:flex;gap:0.5rem;background:var(--bg-card);border-radius:12px;padding:0.5rem;margin-bottom:1rem}
.tab{flex:1;padding:0.75rem;border-radius:8px;background:transparent;border:none;color:var(--text-muted);font-weight:600;cursor:pointer;transition:all .2s}
.tab.active{background:var(--blue);color:white}
.tab-content{display:none}
.tab-content.active{display:block}
.match-card{background:var(--bg-card);border-radius:12px;padding:1rem;margin-bottom:0.75rem}
.match-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem;font-size:0.75rem;color:var(--text-muted)}
.match-id{font-weight:800;color:var(--amber)}
.match-vs{display:flex;align-items:center;gap:0.75rem;font-size:0.875rem}
.team{flex:1;font-weight:600}
.team.placeholder{color:var(--text-muted);font-style:italic}
.vs-divider{color:var(--text-muted);font-weight:800}
.score-input{display:flex;gap:0.5rem;align-items:center;margin-top:0.5rem}
.score-input input{width:50px;padding:0.375rem;background:var(--bg-hover);border:1px solid var(--bg-hover);border-radius:6px;color:var(--text);text-align:center;font-weight:700}
.score-display{font-size:1.25rem;font-weight:800;color:var(--green)}
.status{display:inline-block;padding:0.25rem 0.5rem;border-radius:6px;font-size:0.625rem;font-weight:700;text-transform:uppercase}
.status-waiting{background:rgba(251,191,36,0.2);color:var(--amber)}
.status-live{background:rgba(74,222,128,0.2);color:var(--green)}
.status-done{background:rgba(148,163,184,0.2);color:var(--text-muted)}
.round-section{margin-bottom:1.5rem}
.round-title{font-size:1rem;font-weight:800;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.5rem}
.bracket-compact{background:var(--bg-card);border-radius:12px;padding:1rem;margin-top:1rem}
.bracket-row{display:flex;gap:0.5rem;margin-bottom:0.5rem;font-size:0.75rem}
.bracket-team{background:var(--bg-hover);padding:0.5rem;border-radius:6px;flex:1;font-weight:600}
.bracket-connector{color:var(--text-muted)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--bg-card);border-radius:16px;padding:1.5rem;max-width:400px;width:90%}
.modal-title{font-size:1.25rem;font-weight:800;margin-bottom:1rem}
.input-group{margin-bottom:1rem}
.input-group label{display:block;font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-muted)}
.input-group input{width:100%;padding:0.75rem;background:var(--bg-hover);border:1px solid var(--bg-hover);border-radius:8px;color:var(--text);font-size:1rem}
.alert{padding:1rem;border-radius:8px;margin-bottom:1rem;font-size:0.875rem}
.alert-info{background:rgba(59,130,246,0.2);color:var(--blue)}
.hidden{display:none!important}
.focus-highlight{border:2px solid var(--green);box-shadow:0 0 12px rgba(74,222,128,0.3)}
</style>
</head>
<body>
<div class="container">
<!-- Header -->
<div class="header">
<div>
<div class="title" id="tournamentName">K.O. Turnier</div>
<div class="subtitle" id="tournamentMeta"></div>
</div>
<div style="display:flex;gap:0.5rem">
<button class="btn btn-secondary btn-sm" onclick="refresh()">üîÑ</button>
<button class="btn btn-secondary btn-sm" onclick="toggleFocus()" id="focusBtn">üë§</button>
</div>
</div>

<!-- Tabs -->
<div class="tabs">
<button class="tab active" onclick="switchTab('matches')">üéØ Spiele</button>
<button class="tab" onclick="switchTab('bracket')">üå≥ Baum</button>
</div>

<!-- Tab 1: Matches -->
<div class="tab-content active" id="matchesTab">
<div id="matchesArea"></div>
</div>

<!-- Tab 2: Bracket -->
<div class="tab-content" id="bracketTab">
<div class="alert alert-info">
üì± F√ºr beste Ansicht Handy im Querformat nutzen
</div>
<div id="bracketArea"></div>
</div>

<!-- Password Modal -->
<div class="modal" id="passwordModal">
<div class="modal-content">
<div class="modal-title">Passwort erforderlich</div>
<div class="input-group">
<label>Admin-Passwort</label>
<input type="password" id="passwordInput" placeholder="Passwort">
</div>
<div style="display:flex;gap:0.5rem">
<button class="btn btn-primary" style="flex:1" onclick="checkPassword()">OK</button>
<button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Abbrechen</button>
</div>
</div>
</div>

<!-- Score Modal -->
<div class="modal" id="scoreModal">
<div class="modal-content">
<div class="modal-title">Score eingeben</div>
<div id="scoreMatchInfo" style="margin-bottom:1rem;color:var(--text-muted);font-size:0.875rem"></div>
<div class="input-group">
<label>Score (z.B. 21:15)</label>
<div style="display:flex;gap:0.5rem;align-items:center">
<input type="number" id="score1" placeholder="21" min="0" max="99" style="width:80px">
<span style="font-weight:800">:</span>
<input type="number" id="score2" placeholder="15" min="0" max="99" style="width:80px">
</div>
</div>
<div style="display:flex;gap:0.5rem">
<button class="btn btn-primary" style="flex:1" onclick="saveScore()">Speichern</button>
<button class="btn btn-secondary" style="flex:1" onclick="closeModal()">Abbrechen</button>
</div>
</div>
</div>

<script>
const SB_URL="https://vjcvchczbyvhweiwrunp.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
const supabaseClient=supabase.createClient(SB_URL,SB_KEY);

let tournamentData=null;
let tournamentId=null;
let currentPassword=null;
let pendingMatchId=null;
let focusPlayer=null;

// Init
async function init(){
const params=new URLSearchParams(window.location.search);
tournamentId=params.get('id');
if(!tournamentId){alert('Kein Turnier ausgew√§hlt');return}
await loadTournament();
}

async function loadTournament(){
try{
const{data,error}=await supabaseClient.from('tournaments').select('*').eq('id',tournamentId).single();
if(error)throw error;
tournamentData=data.data;
document.getElementById('tournamentName').textContent=tournamentId;
document.getElementById('tournamentMeta').textContent=`${tournamentData.koTeamCount} Teams ¬∑ ${tournamentData.koCourts} Courts ¬∑ Start: ${tournamentData.koStartTime}`;
renderMatches();
renderBracket();
}catch(e){alert('Fehler beim Laden: '+e.message)}
}

function switchTab(tab){
document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
event.target.classList.add('active');
document.getElementById(tab+'Tab').classList.add('active');
}

function renderMatches(){
const bracket=tournamentData.koBracket;
if(!bracket){document.getElementById('matchesArea').innerHTML='<p>Kein Bracket vorhanden</p>';return}

let html='';

// Vorrunde
if(bracket.prelimMatches?.length){
html+=`<div class="round-section"><div class="round-title">üìã Vorrunde</div>`;
bracket.prelimMatches.forEach(m=>{
const hasScore=m.score1!=null&&m.score2!=null;
const status=hasScore?'done':'waiting';
html+=renderMatchCard(m,status);
});
html+=`</div>`;
}

// Runde 1
if(bracket.mainBracket?.r1?.length){
html+=`<div class="round-section"><div class="round-title">‚ö° Runde 1</div>`;
bracket.mainBracket.r1.forEach(m=>{
const hasScore=m.score1!=null&&m.score2!=null;
const status=hasScore?'done':'waiting';
html+=renderMatchCard(m,status);
});
html+=`</div>`;
}

// Weitere Runden (HF, Finale) √§hnlich...

document.getElementById('matchesArea').innerHTML=html||'<p style="color:var(--text-muted);text-align:center;padding:2rem">Keine Spiele vorhanden</p>';
}

function renderMatchCard(match,status){
const team1=getTeamLabel(match.team1);
const team2=getTeamLabel(match.team2);
const isPlaceholder=team1.includes('Platz')||team2.includes('Platz');
const hasScore=match.score1!=null&&match.score2!=null;
const isFocused=focusPlayer&&(team1.includes(focusPlayer)||team2.includes(focusPlayer));

const statusLabel=status==='done'?'Fertig':status==='live'?'L√§uft':'Wartet';
const statusClass=`status-${status}`;

const courtNames=tournamentData.koCourtNames||[];
const courtLabel=courtNames[match.court-1]||match.court;

return`<div class="match-card ${isFocused?'focus-highlight':''}">
<div class="match-header">
<span class="match-id">${match.id}</span>
<span>Court ${courtLabel} ¬∑ ${match.time||'--:--'}</span>
<span class="status ${statusClass}">${statusLabel}</span>
</div>
<div class="match-vs">
<div class="team ${isPlaceholder?'placeholder':''}">${team1}</div>
<div class="vs-divider">VS</div>
<div class="team ${isPlaceholder?'placeholder':''}">${team2}</div>
</div>
${hasScore?`<div class="score-display">${match.score1}:${match.score2}</div>`
:`<button class="btn btn-primary btn-sm" style="margin-top:0.5rem" onclick="openScoreModal('${match.id}')" ${isPlaceholder||tournamentData.password?'':'disabled'}>Score eintragen</button>`}
</div>`;
}

function getTeamLabel(team){
if(!team)return'?';
if(team.a&&team.b)return`${team.a}/${team.b}`;
if(team.name)return team.name;
if(team.rank)return`Platz ${team.rank}`;
return'Wartet...';
}

function openScoreModal(matchId){
if(tournamentData.password&&!currentPassword){
pendingMatchId=matchId;
document.getElementById('passwordModal').classList.add('active');
return;
}
pendingMatchId=matchId;
const match=findMatch(matchId);
if(!match)return;
document.getElementById('scoreMatchInfo').textContent=`${match.id}: ${getTeamLabel(match.team1)} vs ${getTeamLabel(match.team2)}`;
document.getElementById('score1').value='';
document.getElementById('score2').value='';
document.getElementById('scoreModal').classList.add('active');
}

function findMatch(id){
const bracket=tournamentData.koBracket;
let found=bracket.prelimMatches?.find(m=>m.id===id);
if(found)return found;
found=bracket.mainBracket?.r1?.find(m=>m.id===id);
return found;
}

function checkPassword(){
const pw=document.getElementById('passwordInput').value;
if(pw===tournamentData.password){
currentPassword=pw;
closeModal();
if(pendingMatchId)openScoreModal(pendingMatchId);
}else{
alert('Falsches Passwort!');
}
}

async function saveScore(){
const s1=parseInt(document.getElementById('score1').value);
const s2=parseInt(document.getElementById('score2').value);
if(isNaN(s1)||isNaN(s2)){alert('Bitte g√ºltige Scores eingeben');return}

const match=findMatch(pendingMatchId);
if(!match)return;

match.score1=s1;
match.score2=s2;

// Winner berechnen
const winner=s1>s2?match.team1:match.team2;
const loser=s1>s2?match.team2:match.team1;

// N√§chste Runde f√ºllen (vereinfacht)
// TODO: Implementiere volle Winner-Logik

try{
const{error}=await supabaseClient.from('tournaments').update({data:tournamentData}).eq('id',tournamentId);
if(error)throw error;
closeModal();
renderMatches();
renderBracket();
}catch(e){alert('Fehler beim Speichern: '+e.message)}
}

function renderBracket(){
// Phase 2: Voller SVG-Baum
document.getElementById('bracketArea').innerHTML=`
<div class="bracket-compact">
<h3 style="margin-bottom:1rem">üèÜ Winner Bracket</h3>
<p style="color:var(--text-muted)">Voller Turnierbaum kommt in Phase 2</p>
<div style="margin-top:1rem;font-size:0.75rem;line-height:1.8">
Vorschau (vereinfacht):<br>
V1 ‚îÄ‚îÄ‚îê<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚îú‚îÄ R1a<br>
V2 ‚îÄ‚îÄ‚îò<br>
</div>
</div>`;
}

function closeModal(){
document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'));
document.getElementById('passwordInput').value='';
}

function toggleFocus(){
const player=prompt('Spielername eingeben:');
if(player){
focusPlayer=player;
document.getElementById('focusBtn').textContent=`üë§ ${player}`;
renderMatches();
}else{
focusPlayer=null;
document.getElementById('focusBtn').textContent='üë§';
renderMatches();
}
}

function refresh(){
loadTournament();
}

init();
</script>
</body>
</html>
