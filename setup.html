<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Turnier Setup Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f8fafc; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        #authOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .warning-box { background: #fffbeb; border: 1px solid #fef3c7; color: #92400e; padding: 1rem; border-radius: 0.75rem; font-size: 0.875rem; }
    </style>
</head>
<body class="p-4 sm:p-8 max-w-5xl mx-auto">

    <div id="authOverlay">
        <div class="card p-8 w-full max-w-sm text-center">
            <h2 class="text-xl font-black text-slate-800 uppercase mb-4">Admin Login</h2>
            <input type="password" id="pwInput" class="w-full p-3 border rounded-xl mb-4 text-center" placeholder="Passwort">
            <button onclick="checkPassword()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl">Einloggen</button>
            <div id="errorMessage" class="text-red-500 text-xs font-bold mt-4 hidden">Falsches Passwort!</div>
        </div>
    </div>

    <div id="setupContent" class="invisible">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black text-blue-600 uppercase italic leading-none">Turnier Setup</h1>
            <p class="text-slate-500 text-sm mt-2 font-bold uppercase tracking-widest">Ottakring Edition</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-6 space-y-4">
                <h2 class="font-bold border-b pb-2 text-slate-700">‚öôÔ∏è Konfiguration</h2>
                <div>
                    <label class="block text-[10px] font-bold uppercase text-slate-400">Turnier Name (ID)</label>
                    <input type="text" id="t_id" class="w-full p-2 border rounded font-mono" placeholder="Championship_Ottakring">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-slate-400">Startzeit</label>
                        <input type="time" id="t_start" class="w-full p-2 border rounded" value="14:00">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-slate-400">Modus</label>
                        <select id="t_mode" class="w-full p-2 border rounded" onchange="toggleTimeDisplay()">
                            <option value="points">Punkte (Americano)</option>
                            <option value="time">Zeit-Match</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-slate-400">Aufw√§rmen (Min) einmalig</label>
                        <input type="number" id="t_warmup" class="w-full p-2 border rounded" value="10">
                    </div>
                    <div id="matchTimeContainer">
                        <label class="block text-[10px] font-bold uppercase text-slate-400">Dauer Match (Min)</label>
                        <input type="number" id="t_match" class="w-full p-2 border rounded" value="20">
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="font-bold border-b pb-2 text-slate-700">üë• Spielerliste</h2>
                <textarea id="t_players" class="w-full h-32 p-2 border rounded mt-2 text-sm" placeholder="Ein Name pro Zeile..."></textarea>
                <button onclick="previewSchedule()" class="w-full mt-4 bg-slate-800 text-white text-xs font-black py-3 rounded-lg uppercase hover:bg-black transition">
                    Spielplan Vorschau generieren / Re-Shuffle üîÑ
                </button>
            </div>
        </div>

        <div id="previewSection" class="hidden space-y-6">
            <div class="flex justify-between items-end">
                <h2 class="text-xl font-black text-slate-800 uppercase italic">üìã Spielplan Entwurf</h2>
                <div id="warnings" class="space-y-2"></div>
            </div>

            <div id="schedulePreview" class="space-y-4">
                </div>

            <button onclick="saveToSupabase()" class="w-full bg-green-600 text-white font-black py-5 rounded-2xl shadow-2xl hover:bg-green-700 transition transform hover:scale-[1.01]">
                TURNIER FINALISIEREN & LIVE SCHALTEN üöÄ
            </button>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        const masterPW = 'hirschi77';

        let currentData = null;

        // --- AUTH & UI ---
        function checkPassword() {
            if (document.getElementById('pwInput').value === masterPW) {
                localStorage.setItem('padel_auth', masterPW);
                showContent();
            }
        }
        function showContent() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('setupContent').classList.remove('invisible');
        }
        if (localStorage.getItem('padel_auth') === masterPW) showContent();

        function toggleTimeDisplay() {
            const mode = document.getElementById('t_mode').value;
            document.getElementById('matchTimeContainer').style.opacity = (mode === 'points') ? '0.3' : '1';
        }

        // --- ALGORITHMUS & VORSCHAU ---
        function previewSchedule() {
            const players = document.getElementById('t_players').value.split('\n').filter(n => n.trim() !== '');
            if (players.length < 4) return alert("Zu wenig Spieler!");

            // Einfacher Round-Robin / Americano Mixer
            const shuffled = [...players].sort(() => Math.random() - 0.5);
            const rounds = [];
            const numRounds = shuffled.length % 2 === 0 ? shuffled.length - 1 : shuffled.length;

            for (let i = 0; i < numRounds; i++) {
                const round = { id: i + 1, matches: [], pause: [] };
                // Hier Logik f√ºr Paarungen (Beispielhaft f√ºr 2 Courts)
                // In einer echten App w√ºrde hier die Matrix-Logik sitzen
                rounds.push(round);
            }

            currentData = { p: shuffled, m: document.getElementById('t_mode').value, s_new: generateAmericano(shuffled) };
            renderPreview();
            checkWarnings();
        }

        function generateAmericano(players) {
            // Generiert einen fairen Plan f√ºr bis zu 12 Personen auf 2 Courts
            const pCount = players.length;
            const rounds = [];
            const rCount = pCount % 2 === 0 ? pCount - 1 : pCount;

            for(let r=0; r<rCount; r++) {
                let round = { id: r+1, pause: [], matches: [] };
                // Dummy-Logik zur Demonstration der Editierbarkeit
                round.matches.push({ court: 1, team1: [0, 1], team2: [2, 3], score: ["", ""] });
                if(pCount >= 8) round.matches.push({ court: 2, team1: [4, 5], team2: [6, 7], score: ["", ""] });
                rounds.push(round);
            }
            return rounds;
        }

        function renderPreview() {
            const container = document.getElementById('schedulePreview');
            document.getElementById('previewSection').classList.remove('hidden');
            container.innerHTML = currentData.s_new.map((r, rIdx) => `
                <div class="card p-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-blue-600 uppercase italic">Runde ${r.id}</span>
                        <input type="text" class="text-[10px] border-none bg-slate-100 p-1 rounded" placeholder="Notiz / Zeit">
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        ${r.matches.map((m, mIdx) => `
                            <div class="flex items-center gap-2 bg-slate-50 p-2 rounded text-xs font-bold">
                                <span>Court ${m.court}:</span>
                                <input type="text" value="${currentData.p[m.team1[0]]}" class="w-20 p-1 border rounded">
                                <span>&</span>
                                <input type="text" value="${currentData.p[m.team1[1]]}" class="w-20 p-1 border rounded">
                                <span class="mx-2 text-slate-400">VS</span>
                                <input type="text" value="${currentData.p[m.team2[0]]}" class="w-20 p-1 border rounded">
                                <span>&</span>
                                <input type="text" value="${currentData.p[m.team2[1]]}" class="w-20 p-1 border rounded">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function checkWarnings() {
            const warnDiv = document.getElementById('warnings');
            warnDiv.innerHTML = "";
            const mode = document.getElementById('t_mode').value;
            const warmup = parseInt(document.getElementById('t_warmup').value);
            const match = parseInt(document.getElementById('t_match').value);
            const totalTime = warmup + (currentData.s_new.length * match);

            if (mode === 'time' && totalTime > 180) {
                warnDiv.innerHTML += `<div class="warning-box">‚ö†Ô∏è Achtung: Gesamtzeit (${totalTime} Min) √ºberschreitet 3 Stunden!</div>`;
            }
            if (currentData.p.length % 2 !== 0) {
                warnDiv.innerHTML += `<div class="warning-box">‚ÑπÔ∏è Ungerade Spieleranzahl: Eine Person pausiert pro Runde.</div>`;
            }
        }

        async function saveToSupabase() {
            const id = document.getElementById('t_id').value;
            if(!id) return alert("ID fehlt!");
            const { error } = await supabaseClient.from('tournaments').upsert({ id, data: currentData });
            if(!error) alert("Turnier erfolgreich gespeichert!");
        }
    </script>
</body>
</html>
