<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Turnier Setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .input-card { background: white; border-radius: 1.5rem; padding: 2rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; }
        label { display: block; font-size: 0.75rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.1em; color: #64748b; margin-bottom: 0.5rem; }
        input, select { width: 100%; padding: 1rem; border-radius: 1rem; border: 2px solid #e2e8f0; font-weight: 700; outline: none; transition: all 0.2s; }
        input:focus { border-color: #3b82f6; }
        .btn-primary { background: #000; color: #fff; padding: 1.25rem; border-radius: 1rem; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; width: 100%; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); }
        .warning-box { background: #fef2f2; border: 2px solid #fee2e2; color: #991b1b; padding: 1rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 700; margin-bottom: 1rem; display: none; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-md mx-auto p-6">
        <h1 class="text-4xl font-[900] italic uppercase tracking-tighter mb-10 mt-6">Turnier Setup</h1>

        <div class="space-y-6">
            <div class="input-card">
                <div class="mb-6">
                    <label>Turnier Name / ID</label>
                    <input type="text" id="tId" placeholder="z.B. padel-cup-2024">
                </div>
                <div class="relative">
                    <label>Admin Passwort</label>
                    <input type="password" id="tPw" placeholder="Passwort vergeben">
                    <button onclick="togglePw()" class="absolute right-4 top-10 text-xl">üëÅÔ∏è</button>
                </div>
            </div>

            <div class="input-card">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label>Pl√§tze</label>
                        <input type="number" id="tCourts" value="2" oninput="checkConsistency()">
                    </div>
                    <div>
                        <label>Typ</label>
                        <select id="tType" onchange="checkConsistency()">
                            <option value="single">Einzelspieler</option>
                            <option value="team">Feste Teams</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label>Teilnehmer (pro Zeile einer)</label>
                    <textarea id="tPlayers" oninput="checkConsistency()" class="w-full h-40 p-4 border-2 border-e2e8f0 rounded-xl font-bold outline-none focus:border-blue-500" placeholder="Spieler 1&#10;Spieler 2..."></textarea>
                </div>
            </div>

            <div class="input-card">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label>Startzeit</label>
                        <input type="time" id="tStartTime" value="18:00" oninput="checkConsistency()">
                    </div>
                    <div>
                        <label>Endzeit</label>
                        <input type="time" id="tEndTime" value="20:00" oninput="checkConsistency()">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label>Aufw√§rmen (min)</label>
                        <input type="number" id="tWarmup" value="0">
                    </div>
                    <div>
                        <label>Rundenzeit (min)</label>
                        <input type="number" id="tDuration" value="20" oninput="checkConsistency()">
                    </div>
                </div>
            </div>

            <div id="consistencyWarning" class="warning-box"></div>
            <button onclick="saveAndGenerate()" class="btn-primary">Plan bestm√∂glich mischen & speichern</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        function togglePw() {
            const el = document.getElementById('tPw');
            el.type = el.type === 'password' ? 'text' : 'password';
        }

        function checkConsistency() {
            const players = document.getElementById('tPlayers').value.split('\n').filter(n => n.trim() !== "");
            const type = document.getElementById('tType').value;
            const courts = parseInt(document.getElementById('tCourts').value);
            const duration = parseInt(document.getElementById('tDuration').value);
            const start = document.getElementById('tStartTime').value;
            const end = document.getElementById('tEndTime').value;
            const warnBox = document.getElementById('consistencyWarning');

            if (players.length < 4 || !start || !end) return;

            const totalMin = (new Date(`1970-01-01T${end}`) - new Date(`1970-01-01T${start}`)) / 60000;
            const rounds = Math.floor(totalMin / duration);
            const units = type === 'team' ? players.length / 2 : players.length;
            const playersPerRound = courts * 4;
            
            const totalSlots = rounds * playersPerRound;
            const isConsistent = (totalSlots % units === 0);

            if (!isConsistent && rounds > 0) {
                let suggestion = duration;
                for(let d = 10; d <= 60; d += 5) {
                    let r = Math.floor(totalMin / d);
                    if((r * playersPerRound) % units === 0) { suggestion = d; break; }
                }
                warnBox.innerHTML = `‚ö†Ô∏è Ungleichm√§√üige Verteilung! Nicht alle Spieler spielen gleich oft.<br><b>Vorschlag: ${suggestion}min Rundenzeit</b> f√ºr ein faireres Ergebnis.`;
                warnBox.style.display = 'block';
            } else {
                warnBox.style.display = 'none';
            }
        }

        async function saveAndGenerate() {
            const id = document.getElementById('tId').value.trim();
            if(!id) return alert("ID fehlt!");

            const players = document.getElementById('tPlayers').value.split('\n').filter(n => n.trim() !== "");
            const warmup = parseInt(document.getElementById('tWarmup').value) || 0;
            const duration = parseInt(document.getElementById('tDuration').value);
            const courts = parseInt(document.getElementById('tCourts').value);
            const start = document.getElementById('tStartTime').value;
            const end = document.getElementById('tEndTime').value;
            const type = document.getElementById('tType').value;

            if (players.length < 4) return alert("Zu wenig Teilnehmer!");

            let schedule = [];
            const totalMin = (new Date(`1970-01-01T${end}`) - new Date(`1970-01-01T${start}`)) / 60000;
            const roundCount = Math.floor(totalMin / duration);
            let playerIndices = players.map((_, i) => i);
            
            // TRACKER F√úR WIEDERHOLUNGEN
            let partnerHistory = Array.from({length: players.length}, () => []);
            let opponentHistory = Array.from({length: players.length}, () => []);

            for(let r=0; r < roundCount; r++) {
                let available = [...playerIndices].sort(() => Math.random() - 0.5);
                let roundMatches = [];
                
                for(let c=0; c < courts; c++) {
                    if(available.length < 4) break;

                    let p1 = available.shift();
                    // Finde Partner p2, der am seltensten mit p1 gespielt hat
                    available.sort((a, b) => partnerHistory[p1].filter(x => x === a).length - partnerHistory[p1].filter(x => x === b).length);
                    let p2 = available.shift();

                    // Finde Gegner p3, p4, gegen die p1/p2 am seltensten gespielt haben
                    available.sort((a, b) => (opponentHistory[p1].filter(x => x === a).length + opponentHistory[p2].filter(x => x === a).length) - 
                                             (opponentHistory[p1].filter(x => x === b).length + opponentHistory[p2].filter(x => x === b).length));
                    let p3 = available.shift();
                    let p4 = available.shift();

                    // History updaten
                    partnerHistory[p1].push(p2); partnerHistory[p2].push(p1);
                    partnerHistory[p3].push(p4); partnerHistory[p4].push(p3);
                    [p1, p2].forEach(p => opponentHistory[p].push(p3, p4));
                    [p3, p4].forEach(p => opponentHistory[p].push(p1, p2));

                    roundMatches.push({
                        court: ((c + r) % courts) + 1,
                        team1: [p1, p2],
                        team2: [p3, p4],
                        score: ["", ""]
                    });
                }

                let time = new Date(`1970-01-01T${start}`);
                time.setMinutes(time.getMinutes() + warmup + (r * duration));
                let pauseIndices = playerIndices.filter(i => !roundMatches.some(m => m.team1.includes(i) || m.team2.includes(i)));

                schedule.push({ id: r+1, time: time.toTimeString().substring(0,5), matches: roundMatches, pause: pauseIndices });
            }

            const payload = {
                pw: document.getElementById('tPw').value,
                type: type,
                p: players,
                s_new: schedule,
                warmup: warmup,
                duration: duration,
                courts: courts,
                start: start,
                end: end
            };

            const { error } = await supabaseClient.from('tournaments').upsert({ id: id, data: payload });
            if(error) alert("Fehler: " + error.message);
            else alert("Turnier gespeichert! Mischer hat Partner & Gegner optimiert.");
        }

        async function loadExisting() {
            const urlId = new URLSearchParams(window.location.search).get('id');
            if(urlId) {
                const { data } = await supabaseClient.from('tournaments').select('*').eq('id', urlId);
                if(data && data[0]) {
                    const d = data[0].data;
                    document.getElementById('tId').value = data[0].id;
                    document.getElementById('tPw').value = d.pw || "";
                    document.getElementById('tWarmup').value = d.warmup !== undefined ? d.warmup : 0;
                    document.getElementById('tPlayers').value = (d.p || []).join('\n');
                    document.getElementById('tType').value = d.type || "single";
                    document.getElementById('tCourts').value = d.courts || 2;
                    document.getElementById('tStartTime').value = d.start || "18:00";
                    document.getElementById('tEndTime').value = d.end || "20:00";
                    document.getElementById('tDuration').value = d.duration || 20;
                    checkConsistency();
                }
            }
        }
        loadExisting();
    </script>
</body>
</html>
