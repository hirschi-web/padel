<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Setup - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background-color: #f1f5f9; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); padding: 1.5rem; }
        input { border: 1px solid #cbd5e1; padding: 0.5rem; border-radius: 0.5rem; outline: none; }
        input:focus { border-color: #3b82f6; ring: 2px; ring-color: #3b82f6; }
        .btn { padding: 0.6rem 1.2rem; border-radius: 0.75rem; font-weight: bold; transition: all 0.2s; cursor: pointer; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
    </style>
</head>
<body class="p-4 max-w-4xl mx-auto space-y-6">

    <header class="flex justify-between items-center">
        <h1 class="text-2xl font-black text-slate-800 uppercase italic">Tournament Admin</h1>
        <div id="statusTag" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-500 uppercase">Offline</div>
    </header>

    <section class="card space-y-4">
        <h2 class="font-bold text-slate-500 uppercase text-xs tracking-widest">Turnier Verwaltung</h2>
        <div class="flex flex-wrap gap-3">
            <select id="tournamentSelect" class="flex-1 min-w-[200px] p-2 rounded-lg border border-slate-300 font-medium">
                <option value="">-- Turnier wählen --</option>
            </select>
            <button onclick="loadSelectedTournament()" class="btn btn-primary">Laden</button>
            <button onclick="deleteTournament()" class="btn btn-danger">Löschen</button>
        </div>
        <div class="flex gap-3">
            <input type="text" id="newTournamentName" placeholder="Neuer Turniername (z.B. Ottakring_10)" class="flex-1">
            <button onclick="createNewTournament()" class="btn bg-green-500 text-white">Neu Erstellen</button>
        </div>
    </section>

    <section class="card space-y-4">
        <div class="flex justify-between items-center">
            <h2 class="font-bold text-slate-500 uppercase text-xs tracking-widest">Teilnehmer</h2>
            <span id="playerCount" class="text-xs font-bold text-blue-600">0 Spieler</span>
        </div>
        <div id="playerInputs" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
            </div>
        <button onclick="addPlayerField()" class="text-blue-500 text-sm font-bold">+ Spieler hinzufügen</button>
    </section>

    <section class="card grid grid-cols-2 gap-6">
        <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Anzahl Courts</label>
            <input type="number" id="courtCount" value="2" class="w-full">
        </div>
        <div>
            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Anzahl Runden</label>
            <input type="number" id="roundCount" value="4" class="w-full">
        </div>
    </section>

    <section class="flex flex-col gap-3">
        <button onclick="generateSchedule()" class="btn bg-slate-800 text-white text-lg">Spielplan generieren & Aktivieren</button>
        <p class="text-center text-[10px] text-slate-400 uppercase font-bold">Achtung: Generieren setzt alle Spielstände zurück!</p>
    </section>

    <script>
        const SB_URL = "https://vjcvchczbyvhweiwrunp.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqY3ZjaGN6Ynl2aHdlaXdydW5wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NjkzNjYsImV4cCI6MjA4NTM0NTM2Nn0.A01bxl9dNzgmeDcOV2HZIIa2pN5vhWg3q0_FhqO1R2M";
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let currentT_ID = "";
        let players = [];

        // Initialisierung
        async function init() {
            const { data } = await supabaseClient.from('tournaments').select('id').neq('id', 'LIVE_CONFIG');
            const select = document.getElementById('tournamentSelect');
            data.forEach(t => {
                let opt = document.createElement('option');
                opt.value = t.id; opt.innerText = t.id;
                select.appendChild(opt);
            });
            // Standardmäßig 8 Felder anzeigen
            for(let i=0; i<8; i++) addPlayerField();
        }

        function addPlayerField(name = "") {
            const container = document.getElementById('playerInputs');
            const idx = container.children.length;
            const input = document.createElement('input');
            input.type = "text";
            input.placeholder = `Spieler ${idx + 1}`;
            input.value = name;
            input.className = "player-input";
            container.appendChild(input);
            updatePlayerCount();
        }

        function updatePlayerCount() {
            const count = Array.from(document.querySelectorAll('.player-input')).filter(i => i.value.trim() !== "").length;
            document.getElementById('playerCount').innerText = `${count} Spieler`;
        }

        async function createNewTournament() {
            const name = document.getElementById('newTournamentName').value.trim();
            if(!name) return alert("Name fehlt!");
            
            const emptyData = { p: [], s_new: [] };
            const { error } = await supabaseClient.from('tournaments').insert([{ id: name, data: emptyData }]);
            
            if(error) alert("Fehler: " + error.message);
            else location.reload();
        }

        async function loadSelectedTournament() {
            const id = document.getElementById('tournamentSelect').value;
            if(!id) return;
            
            const { data } = await supabaseClient.from('tournaments').select('data').eq('id', id).single();
            if(data) {
                currentT_ID = id;
                document.getElementById('statusTag').innerText = "Aktiv: " + id;
                document.getElementById('statusTag').classList.replace('text-slate-500', 'text-blue-600');
                
                // Felder füllen
                const container = document.getElementById('playerInputs');
                container.innerHTML = "";
                data.data.p.forEach(name => addPlayerField(name));
                if(data.data.p.length < 8) {
                    for(let i=data.data.p.length; i<8; i++) addPlayerField();
                }
            }
        }

        async function deleteTournament() {
            const id = document.getElementById('tournamentSelect').value;
            if(!id) return;
            
            // Deine gewünschte Bestätigung
            const confirmed = confirm(`Bist du sicher, dass du das Turnier "${id}" unwiderruflich löschen möchtest?`);
            if(!confirmed) return;

            const { error } = await supabaseClient.from('tournaments').delete().eq('id', id);
            if(error) alert("Fehler beim Löschen");
            else location.reload();
        }

        async function generateSchedule() {
            const id = currentT_ID || document.getElementById('tournamentSelect').value;
            if(!id) return alert("Bitte erst ein Turnier laden oder wählen!");

            const playerList = Array.from(document.querySelectorAll('.player-input'))
                                    .map(i => i.value.trim())
                                    .filter(i => i !== "");
            
            if(playerList.length < 4) return alert("Zu wenig Spieler!");

            const courts = parseInt(document.getElementById('courtCount').value);
            const rounds = parseInt(document.getElementById('roundCount').value);
            
            // Einfacher Zufalls-Algorithmus für Padel-Paarungen
            let schedule = [];
            for(let r=1; r<=rounds; r++) {
                let round = { id: r, matches: [] };
                let pool = [...Array(playerList.length).keys()].sort(() => Math.random() - 0.5);
                
                for(let c=1; c<=courts; c++) {
                    if(pool.length >= 4) {
                        round.matches.push({
                            court: c,
                            team1: [pool.pop(), pool.pop()],
                            team2: [pool.pop(), pool.pop()],
                            score: ["", ""]
                        });
                    }
                }
                schedule.push(round);
            }

            const finalData = { p: playerList, s_new: schedule };

            // 1. Turnier-Daten updaten
            await supabaseClient.from('tournaments').update({ data: finalData }).eq('id', id);

            // 2. LIVE_CONFIG aktualisieren (Damit live.html sofort umschaltet)
            await supabaseClient.from('tournaments').update({ 
                data: { active_id: id } 
            }).eq('id', 'LIVE_CONFIG');

            alert("Spielplan generiert und als LIVE gesetzt!");
        }

        init();
    </script>
</body>
</html>
